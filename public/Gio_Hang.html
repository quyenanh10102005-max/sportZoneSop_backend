<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gi·ªè h√†ng - SportZoneVN</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="Trang_chu.css">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <style>
    body {
      background-color: #f9f9f9;
      font-family: 'Times New Roman', Times, serif;
    }

    .cart-container {
      max-width: 900px;
      margin: 80px auto;
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .cart-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid #ddd;
      padding: 15px 0;
    }

    .cart-item img {
      width: 80px;
      border-radius: 8px;
    }

    .cart-info {
      flex: 1;
      margin-left: 15px;
    }

    .cart-total {
      text-align: right;
      font-size: 1.2rem;
      font-weight: bold;
      margin-top: 20px;
    }

    .btn-remove {
      background: none;
      border: none;
      color: red;
      font-size: 18px;
      cursor: pointer;
    }

    .btn-checkout {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 25px;
      border-radius: 5px;
      font-weight: bold;
      transition: 0.3s;
    }

    .btn-checkout:hover {
      background: #0056b3;
    }
  </style>
</head>

<body>
  <div class="welcome">Ch√†o m·ª´ng ƒë·∫øn v·ªõi SportZoneVn - Gi√†y b√≥ng ƒë√° ch√≠nh h√£ng Vi·ªát Nam</div>

  <header>
    <div class="header-logo"><img src="/images/Logo_.png" alt=""></div>

    <div class="header-search">
      <i class="fa-solid fa-magnifying-glass"></i>
      <input type="text" placeholder="T√¨m ki·∫øm s·∫£n ph·∫©m ...">
    </div>

    <div class="header_menu">
      <i class="fa-solid fa-user" id="userIcon"></i>
      <span id="userName" style="margin-left: 8px; font-weight: bold;"></span>
      <ul class="header_main_menu" id="menuList">
        <li id="registerLi"><a href="./Dang_ky.html">ƒêƒÉng k√Ω</a></li>
        <li id="loginLi"><a href="./Dang_nhap.html">ƒêƒÉng nh·∫≠p</a></li>
        <li id="logoutLi"><a href="./Dang_nhap.html">ƒêƒÉng xu·∫•t</a></li>
      </ul>
    </div>

    <div class="header_gio_hang">
      <a href="Gio_hang.html"><i class="fa-solid fa-cart-shopping"></i></a>
    </div>
  </header>

  <nav>
    <ul class="main_menu">
      <li><a href="Trang_chu.html">Trang ch·ªß</a></li>

      <li class="submenu">
        <a href="#">Gi√†y b√≥ng ƒë√°</a>
        <ul class="has_submenu">
          <li><a href="#">T·∫•t c·∫£ s·∫£n ph·∫©m</a></li>
          <li><a href="#">Gi√†y s√¢n c·ªè nh√¢n t·∫°o</a></li>
          <li><a href="#">Gi√†y s√¢n c·ªè t·ª± nhi√™n</a></li>
          <li><a href="#">Gi√†y s√¢n Futsal</a></li>
        </ul>
      </li>

      <li class="submenu">
        <a href="#">Th∆∞∆°ng hi·ªáu</a>
        <ul class="has_submenu">
          <li><a href="#">Nike</a></li>
          <li><a href="#">Adidas</a></li>
          <li><a href="#">Puma</a></li>
          <li><a href="#">Mizuno</a></li>
          <li><a href="#">Kamito</a></li>
          <li><a href="#">Zocker</a></li>
        </ul>
      </li>

      <li><a href="Phu_Kien.html">Ph·ª• ki·ªán</a></li>
      <li><a href="Tin_Tuc_Giay.html">Tin t·ª©c gi√†y</a></li>
      <li><a href="Khuyen_Mai.html">Khuy·∫øn m√£i</a></li>
      <li><a href="Ve_chung_toi.html">V·ªÅ ch√∫ng t√¥i</a></li>
    </ul>
  </nav>

  <main>
    <div class="container cart-container">
      <h2 class="mb-4 text-center">üõí Gi·ªè h√†ng c·ªßa b·∫°n</h2>
      <div id="cartItems"></div>
      <div id="cartTotal" class="cart-total"></div>
      <div class="text-end mt-3">
        <button class="btn-checkout" id="checkoutBtn">Thanh to√°n</button>
      </div>
    </div>
  </main>

  <footer>
    <div class="hotline">
      <h2>TH√îNG TIN LI√äN H·ªÜ</h2>
      <h1>SportZoneVN - Gi√†y b√≥ng ƒë√°</h1>
      <p><i class="fa-solid fa-location-dot"></i> ƒê·ªãa ch·ªâ: ƒê√¥ng Y√™n - ƒê√¥ng S∆°n - Thanh H√≥a</p>
      <p><i class="fa-solid fa-phone"></i> Hotline: 0329127111</p>
      <p><i class="fa-solid fa-envelope"></i> Email: Doaducthiendeptrai@gmail.com</p>
    </div>

    <div class="lien_ket">
      <a href="https://www.facebook.com/thien.uc.609096"><i class="fa-brands fa-facebook"></i></a>
      <a href="https://www.instagram.com/qanh1010/"><i class="fa-brands fa-instagram"></i></a>
      <a href="https://www.youtube.com/@quyenanh8600"><i class="fa-brands fa-youtube"></i></a>
    </div>
  </footer>

  <div class="gb">SportZoneVn - Gi√†y b√≥ng ƒë√° ch√≠nh h√£ng Vi·ªát Nam</div>

  <script>
  // X·ª≠ l√Ω hi·ªÉn th·ªã ng∆∞·ªùi d√πng ƒëƒÉng nh·∫≠p
  const user = localStorage.getItem("user");
  const userNameSpan = document.getElementById("userName");
  const registerLi = document.getElementById("registerLi");
  const loginLi = document.getElementById("loginLi");
  const logoutLi = document.getElementById("logoutLi");
  let currentUserId = null; // L∆∞u ID ng∆∞·ªùi d√πng

  if (user) {
    const userData = JSON.parse(user);
    currentUserId = userData._id; // L∆∞u l·∫°i _id
    userNameSpan.textContent = userData.TenDangNhap;
    registerLi.style.display = "none";
    loginLi.style.display = "none";
    logoutLi.style.display = "block";
  } else {
    userNameSpan.textContent = "";
    registerLi.style.display = "block";
    loginLi.style.display = "block";
    logoutLi.style.display = "none";
  }

  logoutLi.querySelector('a').addEventListener('click', function(e) {
    e.preventDefault();
    localStorage.removeItem('token');
    localStorage.removeItem('user');
    window.location.href = "Dang_nhap.html";
  });

  // ‚úÖ [ƒê√É S·ª¨A] Hi·ªÉn th·ªã gi·ªè h√†ng t·ª´ API
  async function renderCart() {
    const container = document.getElementById("cartItems");
    const totalEl = document.getElementById("cartTotal");

    if (!currentUserId) {
      container.innerHTML = '<p class="text-center text-muted">Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ xem gi·ªè h√†ng.</p>';
      totalEl.textContent = "";
      return;
    }

    try {
      const res = await fetch(`/api/giohang/${currentUserId}`); 
      const cart = await res.json();

      if (!cart.length) {
        container.innerHTML = '<p class="text-center text-muted">Gi·ªè h√†ng tr·ªëng.</p>';
        totalEl.textContent = "";
        return;
      }

      let total = 0;
      container.innerHTML = cart
        .map((item) => {
          // item.MaSanPham ƒë√£ ƒë∆∞·ª£c 'populate' t·ª´ API
          if (!item.MaSanPham) {
            // X·ª≠ l√Ω tr∆∞·ªùng h·ª£p s·∫£n ph·∫©m ƒë√£ b·ªã x√≥a kh·ªèi DB
            return `<div class="cart-item text-danger">M·ªôt s·∫£n ph·∫©m kh√¥ng c√≤n t·ªìn t·∫°i.</div>`;
          }
          const sp = item.MaSanPham;
          const thanhTien = sp.gia * item.SoLuong;
          total += thanhTien;

          return `
            <div class="cart-item">
              <img src="${sp.hinhAnh}" alt="${sp.ten}">
              <div class="cart-info">
                <h5>${sp.ten}</h5>
                <p>Size: ${item.Size} | S·ªë l∆∞·ª£ng: ${item.SoLuong}</p>
                <strong>${sp.gia.toLocaleString()}‚Ç´</strong>
              </div>
              <button class="btn-remove" onclick="removeItem('${item._id}')">
                <i class="fa-solid fa-trash"></i>
              </button>
            </div>
          `;
        })
        .join("");

      totalEl.textContent = `T·ªïng c·ªông: ${total.toLocaleString()}‚Ç´`;

    } catch (err) {
      container.innerHTML = `<p class="text-danger text-center">L·ªói khi t·∫£i gi·ªè h√†ng: ${err}</p>`;
    }
  }

  // ‚úÖ [ƒê√É S·ª¨A] H√†m x√≥a s·∫£n ph·∫©m kh·ªèi gi·ªè h√†ng (G·ªçi API DELETE)
  async function removeItem(itemId) {
    if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a s·∫£n ph·∫©m n√†y kh·ªèi gi·ªè h√†ng?')) {
      return;
    }

    try {
      const res = await fetch(`/api/giohang/${itemId}`, {
        method: 'DELETE'
      });

      if (res.ok) {
        alert('ƒê√£ x√≥a s·∫£n ph·∫©m th√†nh c√¥ng.');
        renderCart(); // T·∫£i l·∫°i gi·ªè h√†ng
        updateCartCount(); // C·∫≠p nh·∫≠t l·∫°i s·ªë l∆∞·ª£ng ·ªü header
      } else {
        const errData = await res.json();
        alert('L·ªói khi x√≥a: ' + (errData.error || 'L·ªói kh√¥ng x√°c ƒë·ªãnh'));
      }
    } catch (err) {
      alert('L·ªói k·∫øt n·ªëi: ' + err);
    }
  }

  // ‚úÖ [ƒê√É S·ª¨A] X·ª≠ l√Ω thanh to√°n (G·ªçi API x√≥a gi·ªè h√†ng)
  document.getElementById('checkoutBtn').addEventListener('click', async () => {
    const totalText = document.getElementById('cartTotal').textContent;
    
    if (!totalText || totalText === "") {
      alert("Gi·ªè h√†ng tr·ªëng, kh√¥ng th·ªÉ thanh to√°n!");
      return;
    }
    
    if (!currentUserId) {
       alert("L·ªói: Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng!");
       return;
    }

    // [T∆Ø∆†NG LAI] ƒê√¢y l√† n∆°i b·∫°n s·∫Ω th√™m logic t·∫°o ƒê∆°n H√†ng
    // ...

    alert("Thanh to√°n th√†nh c√¥ng! C·∫£m ∆°n b·∫°n ƒë√£ mua h√†ng ‚ù§Ô∏è");

    // X√≥a to√†n b·ªô gi·ªè h√†ng c·ªßa kh√°ch h√†ng sau khi thanh to√°n th√†nh c√¥ng
    try {
      await fetch(`/api/giohang/clear/${currentUserId}`, { 
        method: 'DELETE' 
      });
      renderCart(); // T·∫£i l·∫°i (s·∫Ω th·∫•y gi·ªè tr·ªëng)
      updateCartCount(); // C·∫≠p nh·∫≠t header v·ªÅ 0
    } catch (err) {
      console.error('L·ªói khi x√≥a gi·ªè h√†ng:', err);
    }
  });

  // ‚úÖ [ƒê√É S·ª¨A] H√†m c·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng ·ªü icon gi·ªè h√†ng (Header)
  async function updateCartCount() {
    if (!currentUserId) {
      document.querySelector('.header_gio_hang i').removeAttribute('data-count');
      return;
    }

    try {
      const res = await fetch(`/api/giohang/${currentUserId}`);
      const data = await res.json();
      const cartIcon = document.querySelector('.header_gio_hang i');
      
      if (data.length > 0) {
        cartIcon.setAttribute('data-count', data.length);
      } else {
        cartIcon.removeAttribute('data-count');
      }
    } catch (err) {
       console.error('L·ªói khi c·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng gi·ªè h√†ng:', err);
    }
  }

  // T·∫£i gi·ªè h√†ng v√† c·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng khi trang ƒë∆∞·ª£c m·ªü
  renderCart();
  updateCartCount();
</script>
</body>
</html>
