<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gi·ªè h√†ng - SportZoneVN</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="Trang_chu.css">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <style>
    body {
      background-color: #f9f9f9;
      font-family: 'Times New Roman', Times, serif;
    }

    .cart-container {
      max-width: 900px;
      margin: 80px auto;
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .cart-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid #ddd;
      padding: 15px 0;
    }

    .cart-item img {
      width: 80px;
      border-radius: 8px;
    }

    .cart-info {
      flex: 1;
      margin-left: 15px;
    }

    .cart-total {
      text-align: right;
      font-size: 1.2rem;
      font-weight: bold;
      margin-top: 20px;
    }

    .btn-remove {
      background: none;
      border: none;
      color: red;
      font-size: 18px;
      cursor: pointer;
    }

    .btn-checkout {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 25px;
      border-radius: 5px;
      font-weight: bold;
      transition: 0.3s;
    }

    .btn-checkout:hover {
      background: #0056b3;
    }
  </style>
</head>

<body>
  <div class="welcome">Ch√†o m·ª´ng ƒë·∫øn v·ªõi SportZoneVn - Gi√†y b√≥ng ƒë√° ch√≠nh h√£ng Vi·ªát Nam</div>

  <header>
    <div class="header-logo"><img src="/images/Logo_.png" alt=""></div>

    <div class="header-search">
      <i class="fa-solid fa-magnifying-glass"></i>
      <input type="text" placeholder="T√¨m ki·∫øm s·∫£n ph·∫©m ...">
    </div>

    <div class="header_menu">
      <i class="fa-solid fa-user" id="userIcon"></i>
      <span id="userName" style="margin-left: 8px; font-weight: bold;"></span>
      <ul class="header_main_menu" id="menuList">
        <li id="registerLi"><a href="./Dang_ky.html">ƒêƒÉng k√Ω</a></li>
        <li id="loginLi"><a href="./Dang_nhap.html">ƒêƒÉng nh·∫≠p</a></li>
        <li id="logoutLi"><a href="./Dang_nhap.html">ƒêƒÉng xu·∫•t</a></li>
      </ul>
    </div>

   <div class="header_gio_hang">
  <a href="Gio_Hang.html">
    <i class="fa-solid fa-cart-shopping"></i>
  </a>
</div>
  </header>

  <nav>
    <ul class="main_menu">
      <li><a href="Trang_chu.html">Trang ch·ªß</a></li>

      <li class="submenu">
        <a href="#">Gi√†y b√≥ng ƒë√°</a>
        <ul class="has_submenu">
          <li><a href="#">T·∫•t c·∫£ s·∫£n ph·∫©m</a></li>
          <li><a href="#">Gi√†y s√¢n c·ªè nh√¢n t·∫°o</a></li>
          <li><a href="#">Gi√†y s√¢n c·ªè t·ª± nhi√™n</a></li>
          <li><a href="#">Gi√†y s√¢n Futsal</a></li>
        </ul>
      </li>

      <li class="submenu">
        <a href="#">Th∆∞∆°ng hi·ªáu</a>
        <ul class="has_submenu">
          <li><a href="#">Nike</a></li>
          <li><a href="#">Adidas</a></li>
          <li><a href="#">Puma</a></li>
          <li><a href="#">Mizuno</a></li>
          <li><a href="#">Kamito</a></li>
          <li><a href="#">Zocker</a></li>
        </ul>
      </li>

      <li><a href="Phu_Kien.html">Ph·ª• ki·ªán</a></li>
      <li><a href="Tin_Tuc_Giay.html">Tin t·ª©c gi√†y</a></li>
      <li><a href="Khuyen_Mai.html">Khuy·∫øn m√£i</a></li>
      <li><a href="Ve_chung_toi.html">V·ªÅ ch√∫ng t√¥i</a></li>
    </ul>
  </nav>

  <main>
    <div class="container cart-container">
      <h2 class="mb-4 text-center">üõí Gi·ªè h√†ng c·ªßa b·∫°n</h2>
      <div id="cartItems"></div>
      <div id="cartTotal" class="cart-total"></div>
      <div class="text-end mt-3">
        <button  class="btn-checkout" id="checkoutBtn" >Thanh to√°n</button>
      </div>
    </div>
  </main>

  <footer>
    <div class="hotline">
      <h2>TH√îNG TIN LI√äN H·ªÜ</h2>
      <h1>SportZoneVN - Gi√†y b√≥ng ƒë√°</h1>
      <p><i class="fa-solid fa-location-dot"></i> ƒê·ªãa ch·ªâ: ƒê√¥ng Y√™n - ƒê√¥ng S∆°n - Thanh H√≥a</p>
      <p><i class="fa-solid fa-phone"></i> Hotline: 0329127111</p>
      <p><i class="fa-solid fa-envelope"></i> Email: Doaducthiendeptrai@gmail.com</p>
    </div>

    <div class="lien_ket">
      <a href="https://www.facebook.com/thien.uc.609096"><i class="fa-brands fa-facebook"></i></a>
      <a href="https://www.instagram.com/qanh1010/"><i class="fa-brands fa-instagram"></i></a>
      <a href="https://www.youtube.com/@quyenanh8600"><i class="fa-brands fa-youtube"></i></a>
    </div>
  </footer>

  <div class="gb">SportZoneVn - Gi√†y b√≥ng ƒë√° ch√≠nh h√£ng Vi·ªát Nam</div>

  <script>
   // ======================= X·ª¨ L√ù HI·ªÇN TH·ªä NG∆Ø·ªúI D√ôNG =======================
const user = localStorage.getItem("user");
const userNameSpan = document.getElementById("userName");
const registerLi = document.getElementById("registerLi");
const loginLi = document.getElementById("loginLi");
const logoutLi = document.getElementById("logoutLi");

if (user) {
  const userData = JSON.parse(user);
  userNameSpan.textContent = userData.TenDangNhap || userData.email || 'User';
  registerLi.style.display = "none";
  loginLi.style.display = "none";
  logoutLi.style.display = "block";
} else {
  userNameSpan.textContent = "";
  registerLi.style.display = "block";
  loginLi.style.display = "block";
  logoutLi.style.display = "none";
}

// X·ª≠ l√Ω ƒëƒÉng xu·∫•t
logoutLi.querySelector('a').addEventListener('click', function(e) {
  e.preventDefault();
  if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën ƒëƒÉng xu·∫•t?')) {
    localStorage.removeItem('token');
    localStorage.removeItem('user');
    window.location.href = "Dang_nhap.html";
  }
});

// ======================= HI·ªÇN TH·ªä GI·ªé H√ÄNG =======================
async function renderCart() {
  const user = JSON.parse(localStorage.getItem("user"));
  const container = document.getElementById("cartItems");
  const totalEl = document.getElementById("cartTotal");
  const checkoutBtn = document.getElementById("checkoutBtn");

  // Ki·ªÉm tra ƒëƒÉng nh·∫≠p
  if (!user || !user.MaTK) {
    container.innerHTML = `
      <p class="text-center text-muted">
        Vui l√≤ng <a href="Dang_nhap.html">ƒëƒÉng nh·∫≠p</a> ƒë·ªÉ xem gi·ªè h√†ng.
      </p>
    `;
    totalEl.textContent = "";
    checkoutBtn.disabled = true;
    return;
  }

  // Hi·ªÉn th·ªã loading
  container.innerHTML = '<p class="text-center">ƒêang t·∫£i gi·ªè h√†ng...</p>';

  try {
    // ‚úÖ G·ªçi API l·∫•y gi·ªè h√†ng
    const res = await fetch(`/api/giohang/${user.MaTK}`);
    
    if (!res.ok) {
      throw new Error('Kh√¥ng th·ªÉ t·∫£i gi·ªè h√†ng');
    }
    
    const cart = await res.json();

    // Gi·ªè h√†ng tr·ªëng
    if (!cart || cart.length === 0) {
      container.innerHTML = `
        <div class="text-center text-muted">
          <i class="fa-solid fa-cart-shopping fa-3x mb-3"></i>
          <p>Gi·ªè h√†ng tr·ªëng.</p>
          <a href="Trang_chu.html" class="btn btn-primary">Ti·∫øp t·ª•c mua s·∫Øm</a>
        </div>
      `;
      totalEl.textContent = "";
      checkoutBtn.disabled = true;
      return;
    }

    // Hi·ªÉn th·ªã danh s√°ch s·∫£n ph·∫©m
    let total = 0;
    container.innerHTML = cart
      .map((item) => {
        const sp = item.MaSanPham; // ƒê√£ populate t·ª´ API
        
        // B·ªè qua n·∫øu s·∫£n ph·∫©m kh√¥ng t·ªìn t·∫°i
        if (!sp || !sp._id) {
          console.warn('S·∫£n ph·∫©m kh√¥ng t·ªìn t·∫°i:', item);
          return '';
        }
        
        const thanhTien = sp.gia * item.SoLuong;
        total += thanhTien;

        return `
          <div class="cart-item" data-id="${item._id}">
            <img src="${sp.hinhAnh || '/images/default.jpg'}" 
                 alt="${sp.ten}"
                 onerror="this.src='/images/default.jpg'">
            <div class="cart-info">
              <h5>${sp.ten}</h5>
              <p>
                <span class="badge bg-secondary">Size: ${item.Size}</span>
                <span class="ms-2">S·ªë l∆∞·ª£ng: ${item.SoLuong}</span>
              </p>
              <strong class="text-danger">${sp.gia.toLocaleString()}‚Ç´</strong>
              <div class="text-muted small">
                Th√†nh ti·ªÅn: ${thanhTien.toLocaleString()}‚Ç´
              </div>
            </div>
            <button class="btn-remove" onclick="removeItem('${item._id}')" title="X√≥a">
              <i class="fa-solid fa-trash"></i>
            </button>
          </div>
        `;
      })
      .filter(html => html) // Lo·∫°i b·ªè item r·ªóng
      .join("");

    totalEl.innerHTML = `
      <div>T·ªïng c·ªông: <span class="text-danger">${total.toLocaleString()}‚Ç´</span></div>
      <div class="small text-muted mt-1">(${cart.length} s·∫£n ph·∫©m)</div>
    `;
    checkoutBtn.disabled = false;

  } catch (err) {
    console.error('‚ùå L·ªói:', err);
    container.innerHTML = `
      <div class="alert alert-danger text-center">
        <i class="fa-solid fa-exclamation-triangle"></i>
        L·ªói khi t·∫£i gi·ªè h√†ng: ${err.message}
        <br>
        <button class="btn btn-sm btn-primary mt-2" onclick="renderCart()">
          Th·ª≠ l·∫°i
        </button>
      </div>
    `;
  }
}

// ======================= X√ìA S·∫¢N PH·∫®M =======================
async function removeItem(itemId) {
  if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a s·∫£n ph·∫©m n√†y?')) return;

  try {
    const res = await fetch(`/api/giohang/${itemId}`, {
      method: 'DELETE'
    });

    if (res.ok) {
      // X√≥a kh·ªèi giao di·ªán
      const itemEl = document.querySelector(`[data-id="${itemId}"]`);
      if (itemEl) {
        itemEl.style.opacity = '0.5';
        setTimeout(() => {
          renderCart(); // T·∫£i l·∫°i gi·ªè h√†ng
          updateCartCount(); // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng
        }, 300);
      }
    } else {
      const data = await res.json();
      alert('‚ùå Kh√¥ng th·ªÉ x√≥a: ' + (data.error || 'L·ªói kh√¥ng x√°c ƒë·ªãnh'));
    }
  } catch (err) {
    console.error('‚ùå L·ªói:', err);
    alert('‚ùå L·ªói khi x√≥a s·∫£n ph·∫©m: ' + err.message);
  }
}

// ======================= THANH TO√ÅN =======================
document.getElementById('checkoutBtn').addEventListener('click', async () => {
  const user = JSON.parse(localStorage.getItem('user'));
  if (!user || !user.MaTK) {
    alert('Vui l√≤ng ƒëƒÉng nh·∫≠p!');
    window.location.href = 'Dang_nhap.html';
    return;
  }

  try {
    // L·∫•y gi·ªè h√†ng hi·ªán t·∫°i
    const res = await fetch(`/api/giohang/${user.MaTK}`);
    const cart = await res.json();
    
    if (!cart || cart.length === 0) {
      alert("Gi·ªè h√†ng tr·ªëng, kh√¥ng th·ªÉ thanh to√°n!");
      return;
    }

    // T√≠nh t·ªïng ti·ªÅn
    let total = 0;
    cart.forEach(item => {
      if (item.MaSanPham) {
        total += item.MaSanPham.gia * item.SoLuong;
      }
    });

    // X√°c nh·∫≠n thanh to√°n
    if (!confirm("X√°c nh·∫≠n thanh to√°n?")) {
  return; // Ng∆∞·ªùi d√πng b·∫•m H·ªßy ‚Üí tho√°t
}

window.location.href = 'Thanh_Toan.html';

    // TODO: G·ªçi API t·∫°o ƒë∆°n h√†ng ·ªü ƒë√¢y
    // await fetch('/api/donhang', { method: 'POST', ... });

    // X√≥a t·∫•t c·∫£ s·∫£n ph·∫©m trong gi·ªè
    for (const item of cart) {
      await fetch(`/api/giohang/${item._id}`, { method: 'DELETE' });
    }

    renderCart();
    updateCartCount();

  } catch (err) {
    console.error('‚ùå L·ªói:', err);
    alert('‚ùå L·ªói khi thanh to√°n: ' + err.message);
  }
});

// ======================= C·∫¨P NH·∫¨T S·ªê L∆Ø·ª¢NG GI·ªé H√ÄNG =======================
async function updateCartCount() {
  const user = JSON.parse(localStorage.getItem('user'));
  if (!user || !user.MaTK) return;

  try {
    const res = await fetch(`/api/giohang/${user.MaTK}`);
    const cart = await res.json();
    const count = cart.length || 0;
    
    const cartIcon = document.querySelector('.header_gio_hang i');
    if (cartIcon) {
      cartIcon.setAttribute('data-count', count);
    }
  } catch (err) {
    console.error('L·ªói c·∫≠p nh·∫≠t gi·ªè h√†ng:', err);
  }
}

// ======================= KH·ªûI CH·∫†Y =======================
renderCart();
updateCartCount();
  </script>
</body>
</html>
