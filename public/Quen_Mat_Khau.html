<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quên mật khẩu - SportZoneVN</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="Trang_chu.css">
    <style>
        .verification-step {
            display: none;
        }
        .verification-step.active {
            display: block;
        }
        .code-input-group {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
        }
        .code-input {
            width: 50px;
            height: 60px;
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            border: 2px solid #ddd;
            border-radius: 8px;
        }
        .code-input:focus {
            border-color: #dc3545;
            outline: none;
        }
        .countdown {
            text-align: center;
            margin: 15px 0;
            color: #666;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="welcome">
        <i class="fa-solid fa-star" style="margin-right: 8px;"></i>
        Chào mừng đến với SportZoneVN - Giày bóng đá chính hãng Việt Nam
        <i class="fa-solid fa-star" style="margin-left: 8px;"></i>
    </div>

    <header id="mainHeader">
        <div class="header-logo">
            <a href="Trang_chu.html">
                <img src="/images/Logo_.png" alt="SportZoneVN Logo">
            </a>
        </div>
        <div class="header-search">
            <i class="fa-solid fa-magnifying-glass"></i>
            <input type="text" placeholder="Tìm kiếm sản phẩm ...">
        </div>
        <div class="header_menu">
            <i class="fa-solid fa-user"></i>
        </div>
        <div class="header_gio_hang">
            <a href="Gio_Hang.html">
                <i class="fa-solid fa-cart-shopping"></i>
            </a>
        </div>
    </header>

    <nav>
        <ul class="main_menu">
            <li><a href="Trang_chu.html"><i class="fa-solid fa-house"></i>Trang chủ</a></li>
        </ul>
    </nav>

    <div class="login-container">
        <div class="login-box">
            <!-- BƯỚC 1: NHẬP EMAIL -->
            <div id="step1" class="verification-step active">
                <div class="login-header">
                    <h2><i class="fa-solid fa-key"></i> Quên mật khẩu</h2>
                    <p>Nhập email đã đăng ký để nhận mã xác thực</p>
                </div>

                <form id="forgotForm">
                    <div class="form-group">
                        <i class="fa-solid fa-envelope"></i>
                        <input type="email" id="email" placeholder="Địa chỉ email" required>
                    </div>

                    <button type="submit" class="btn-login">
                        <i class="fa-solid fa-paper-plane"></i> Gửi mã xác thực
                    </button>
                </form>

                <div class="divider"><span>hoặc</span></div>
                <div class="signup-link">
                    Nhớ mật khẩu? <a href="./Dang_nhap.html">Đăng nhập ngay</a>
                </div>
            </div>

            <!-- BƯỚC 2: XÁC THỰC MÃ -->
            <div id="step2" class="verification-step">
                <div class="login-header">
                    <h2><i class="fa-solid fa-shield-halved"></i> Xác thực</h2>
                    <p>Nhập mã 6 số đã gửi đến <strong id="emailDisplay"></strong></p>
                </div>

                <div class="code-input-group">
                    <input type="text" maxlength="1" class="code-input" data-index="0">
                    <input type="text" maxlength="1" class="code-input" data-index="1">
                    <input type="text" maxlength="1" class="code-input" data-index="2">
                    <input type="text" maxlength="1" class="code-input" data-index="3">
                    <input type="text" maxlength="1" class="code-input" data-index="4">
                    <input type="text" maxlength="1" class="code-input" data-index="5">
                </div>

                <div class="countdown">
                    Mã có hiệu lực: <strong id="timer">10:00</strong>
                </div>

                <button id="verifyBtn" class="btn-login">
                    <i class="fa-solid fa-check-circle"></i> Xác thực
                </button>

                <div style="text-align: center; margin-top: 15px;">
                    <button id="resendBtn" class="btn btn-sm btn-outline-secondary">
                        <i class="fa-solid fa-rotate-right"></i> Gửi lại
                    </button>
                    <button id="backBtn1" class="btn btn-sm btn-outline-secondary ms-2">
                        <i class="fa-solid fa-arrow-left"></i> Quay lại
                    </button>
                </div>
            </div>

            <!-- BƯỚC 3: ĐẶT MẬT KHẨU MỚI -->
            <div id="step3" class="verification-step">
                <div class="login-header">
                    <h2><i class="fa-solid fa-lock-open"></i> Đặt mật khẩu mới</h2>
                    <p>Tạo mật khẩu mới cho tài khoản của bạn</p>
                </div>

                <form id="resetForm">
                    <div class="form-group">
                        <i class="fa-solid fa-lock"></i>
                        <input type="password" id="newPassword" placeholder="Mật khẩu mới" required minlength="6">
                    </div>

                    <div class="form-group">
                        <i class="fa-solid fa-lock"></i>
                        <input type="password" id="confirmNewPassword" placeholder="Xác nhận mật khẩu mới" required>
                    </div>

                    <button type="submit" class="btn-login">
                        <i class="fa-solid fa-check"></i> Đặt lại mật khẩu
                    </button>
                </form>
            </div>
        </div>
    </div>

    <footer>
        <div class="footer-section footer-info">
            <h2>THÔNG TIN LIÊN HỆ</h2>
            <h1>SportZoneVN</h1>
            <p>Giày bóng đá chính hãng Việt Nam</p>
            <p><i class="fa-solid fa-location-dot"></i> Đông Yên - Đông Sơn - Thanh Hóa</p>
            <p><i class="fa-solid fa-phone"></i> <a href="tel:0329127111">0329127111</a></p>
            <p><i class="fa-solid fa-envelope"></i> <a href="mailto:contact@sportzonevn.com">contact@sportzonevn.com</a></p>
        </div>
    </footer>

    <div class="gb">
        <i class="fa-regular fa-copyright"></i> 2025 SportZoneVN
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        const API_BASE_URL = window.location.hostname === 'localhost' 
            ? 'http://localhost:3000' 
            : 'https://sportzonesop.onrender.com';

        let userEmail = '';
        let verificationCode = '';
        let countdownInterval;

        // ======================= BƯỚC 1: GỬI MÃ =======================
        document.getElementById('forgotForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const email = document.getElementById('email').value.trim();
            userEmail = email;

            try {
                Swal.fire({
                    title: 'Đang gửi mã...',
                    allowOutsideClick: false,
                    didOpen: () => Swal.showLoading()
                });

                const res = await fetch(API_BASE_URL + '/api/auth/forgot-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ Email: email })
                });

                const result = await res.json();

                if (res.ok) {
                    Swal.close();
                    document.getElementById('step1').classList.remove('active');
                    document.getElementById('step2').classList.add('active');
                    document.getElementById('emailDisplay').textContent = email;
                    
                    startCountdown(600);
                    document.querySelector('.code-input').focus();

                    Swal.fire({
                        icon: 'success',
                        title: 'Đã gửi mã!',
                        text: 'Vui lòng kiểm tra email.',
                        timer: 3000
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Lỗi!',
                        text: result.message
                    });
                }
            } catch (err) {
                Swal.fire({
                    icon: 'error',
                    title: 'Lỗi kết nối!',
                    text: 'Không thể kết nối server.'
                });
            }
        });

        // ======================= XỬ LÝ NHẬP MÃ =======================
        const codeInputs = document.querySelectorAll('.code-input');
        codeInputs.forEach((input, index) => {
            input.addEventListener('input', function(e) {
                if (e.target.value.length === 1 && index < 5) {
                    codeInputs[index + 1].focus();
                }
            });

            input.addEventListener('keydown', function(e) {
                if (e.key === 'Backspace' && !e.target.value && index > 0) {
                    codeInputs[index - 1].focus();
                }
            });
        });

        // ======================= BƯỚC 2: XÁC THỰC MÃ =======================
        document.getElementById('verifyBtn').addEventListener('click', function() {
            verificationCode = Array.from(codeInputs).map(i => i.value).join('');

            if (verificationCode.length !== 6) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Thiếu mã',
                    text: 'Vui lòng nhập đủ 6 số!'
                });
                return;
            }

            clearInterval(countdownInterval);
            document.getElementById('step2').classList.remove('active');
            document.getElementById('step3').classList.add('active');
        });

        // ======================= BƯỚC 3: ĐẶT LẠI MẬT KHẨU =======================
        document.getElementById('resetForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmNewPassword').value;

            if (newPassword !== confirmPassword) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Mật khẩu không khớp',
                    text: 'Vui lòng kiểm tra lại!'
                });
                return;
            }

            try {
                Swal.fire({
                    title: 'Đang cập nhật...',
                    allowOutsideClick: false,
                    didOpen: () => Swal.showLoading()
                });

                const res = await fetch(API_BASE_URL + '/api/auth/reset-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        Email: userEmail,
                        resetCode: verificationCode,
                        MatKhauMoi: newPassword
                    })
                });

                const result = await res.json();

                if (res.ok) {
                    await Swal.fire({
                        icon: 'success',
                        title: 'Thành công!',
                        text: 'Mật khẩu đã được đặt lại.',
                        confirmButtonText: 'Đăng nhập'
                    });
                    window.location.href = 'Dang_nhap.html';
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Lỗi!',
                        text: result.message
                    });
                }
            } catch (err) {
                Swal.fire({
                    icon: 'error',
                    title: 'Lỗi!',
                    text: 'Không thể đặt lại mật khẩu.'
                });
            }
        });

        // ======================= GỬI LẠI MÃ =======================
        document.getElementById('resendBtn').addEventListener('click', async function() {
            try {
                const res = await fetch(API_BASE_URL + '/api/auth/forgot-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ Email: userEmail })
                });

                if (res.ok) {
                    clearInterval(countdownInterval);
                    startCountdown(600);
                    codeInputs.forEach(input => input.value = '');
                    codeInputs[0].focus();

                    Swal.fire({
                        icon: 'success',
                        title: 'Đã gửi lại!',
                        timer: 2000
                    });
                }
            } catch (err) {
                Swal.fire({
                    icon: 'error',
                    title: 'Lỗi!',
                    text: 'Không thể gửi lại mã.'
                });
            }
        });

        // ======================= QUAY LẠI =======================
        document.getElementById('backBtn1').addEventListener('click', function() {
            clearInterval(countdownInterval);
            document.getElementById('step2').classList.remove('active');
            document.getElementById('step1').classList.add('active');
        });

        // ======================= ĐẾM NGƯỢC =======================
        function startCountdown(seconds) {
            let remaining = seconds;
            const timerEl = document.getElementById('timer');

            countdownInterval = setInterval(() => {
                const minutes = Math.floor(remaining / 60);
                const secs = remaining % 60;
                timerEl.textContent = `${minutes}:${secs.toString().padStart(2, '0')}`;

                if (remaining <= 0) {
                    clearInterval(countdownInterval);
                    timerEl.textContent = 'Hết hạn';
                    document.getElementById('verifyBtn').disabled = true;
                }

                remaining--;
            }, 1000);
        }
    </script>
</body>
</html>