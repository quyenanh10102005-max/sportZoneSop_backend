<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - SportZoneVN</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f6fa;
        }
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            height: 100vh;
            width: 250px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px 0;
            overflow-y: auto;
            z-index: 1000;
        }
        .sidebar-logo {
            text-align: center;
            color: white;
            padding: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .sidebar-logo i {
            font-size: 40px;
            margin-bottom: 10px;
        }
        .sidebar-menu {
            list-style: none;
            padding: 20px 0;
        }
        .sidebar-menu li {
            padding: 15px 25px;
            cursor: pointer;
            transition: all 0.3s;
            color: rgba(255,255,255,0.8);
        }
        .sidebar-menu li:hover,
        .sidebar-menu li.active {
            background: rgba(255,255,255,0.1);
            color: white;
            border-left: 4px solid white;
        }
        .sidebar-menu li i {
            margin-right: 10px;
            width: 20px;
        }
        .main-content {
            margin-left: 250px;
            padding: 20px;
        }
        .top-bar {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }
        .stat-card:hover {
            transform: translateY(-5px);
        }
        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            margin-bottom: 15px;
        }
        .stat-card h3 {
            font-size: 32px;
            font-weight: bold;
            margin: 10px 0;
        }
        .stat-card p {
            color: #7f8c8d;
            margin: 0;
        }
        .content-section {
            display: none;
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .content-section.active {
            display: block;
        }
        .table-actions button {
            margin: 0 2px;
            padding: 5px 10px;
        }
        .btn-logout {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 5px;
        }
        .btn-logout:hover {
            background: #c0392b;
        }
        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .product-img-preview {
            max-width: 80px;
            max-height: 80px;
            object-fit: cover;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-logo">
            <i class="fas fa-user-shield"></i>
            <h4>Admin Panel</h4>
            <p id="adminName" style="font-size: 14px; opacity: 0.8;"></p>
        </div>
        <ul class="sidebar-menu">
            <li class="active" onclick="showSection('dashboard')">
                <i class="fas fa-tachometer-alt"></i>Dashboard
            </li>
            <li onclick="showSection('users')">
                <i class="fas fa-users"></i>Ng∆∞·ªùi d√πng
            </li>
            <li onclick="showSection('products')">
                <i class="fas fa-box"></i>S·∫£n ph·∫©m
            </li>
            <li onclick="showSection('cart')">
                <i class="fas fa-shopping-cart"></i>Gi·ªè h√†ng
            </li>
            <li onclick="showSection('orders')">
                <i class="fas fa-receipt"></i>ƒê∆°n h√†ng
            </li>
            <li onclick="showSection('reviews')">
                <i class="fas fa-star"></i>ƒê√°nh gi√°
            </li>
        </ul>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Top Bar -->
        <div class="top-bar">
            <h2>Ch√†o m·ª´ng, <span id="adminWelcome"></span>!</h2>
            <button class="btn-logout" onclick="logout()">
                <i class="fas fa-sign-out-alt me-2"></i>ƒêƒÉng xu·∫•t
            </button>
        </div>

        <!-- Dashboard Section -->
        <div id="dashboard" class="content-section active">
            <h3 class="mb-4">Th·ªëng k√™ t·ªïng quan</h3>
            <div class="stats-container">
                <div class="stat-card">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        <i class="fas fa-users"></i>
                    </div>
                    <h3 id="totalUsers">0</h3>
                    <p>T·ªïng ng∆∞·ªùi d√πng</p>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                        <i class="fas fa-box"></i>
                    </div>
                    <h3 id="totalProducts">0</h3>
                    <p>T·ªïng s·∫£n ph·∫©m</p>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                        <i class="fas fa-shopping-cart"></i>
                    </div>
                    <h3 id="totalCart">0</h3>
                    <p>Gi·ªè h√†ng</p>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                        <i class="fas fa-receipt"></i>
                    </div>
                    <h3 id="totalOrders">0</h3>
                    <p>ƒê∆°n h√†ng</p>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                        <i class="fas fa-star"></i>
                    </div>
                    <h3 id="totalReviews">0</h3>
                    <p>ƒê√°nh gi√°</p>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #30cfd0 0%, #330867 100%);">
                        <i class="fas fa-dollar-sign"></i>
                    </div>
                    <h3 id="totalRevenue">0ƒë</h3>
                    <p>Doanh thu</p>
                </div>
            </div>
        </div>

        <!-- Users Section -->
        <div id="users" class="content-section">
            <h3 class="mb-4">Qu·∫£n l√Ω ng∆∞·ªùi d√πng</h3>
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>T√™n ƒëƒÉng nh·∫≠p</th>
                            <th>Email</th>
                            <th>Vai tr√≤</th>
                            <th>Ng√†y t·∫°o</th>
                            <th>Thao t√°c</th>
                        </tr>
                    </thead>
                    <tbody id="usersTable"></tbody>
                </table>
            </div>
        </div>

        <!-- Products Section -->
        <div id="products" class="content-section">
            <div class="d-flex justify-content-between mb-4">
                <h3>Qu·∫£n l√Ω s·∫£n ph·∫©m</h3>
                <button class="btn btn-primary" onclick="showAddProductModal()">
                    <i class="fas fa-plus me-2"></i>Th√™m s·∫£n ph·∫©m
                </button>
            </div>
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>H√¨nh ·∫£nh</th>
                            <th>T√™n s·∫£n ph·∫©m</th>
                            <th>Gi√°</th>
                            <th>S·ªë l∆∞·ª£ng</th>
                            <th>Th∆∞∆°ng hi·ªáu</th>
                            <th>Lo·∫°i</th>
                            <th>Thao t√°c</th>
                        </tr>
                    </thead>
                    <tbody id="productsTable"></tbody>
                </table>
            </div>
        </div>

        <!-- Cart Section -->
        <div id="cart" class="content-section">
            <h3 class="mb-4">Qu·∫£n l√Ω gi·ªè h√†ng</h3>
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>Kh√°ch h√†ng</th>
                            <th>S·∫£n ph·∫©m</th>
                            <th>H√¨nh ·∫£nh</th>
                            <th>S·ªë l∆∞·ª£ng</th>
                            <th>Size</th>
                            <th>Ng√†y th√™m</th>
                            <th>Thao t√°c</th>
                        </tr>
                    </thead>
                    <tbody id="cartTable"></tbody>
                </table>
            </div>
        </div>

        <!-- Orders Section -->
        <div id="orders" class="content-section">
            <h3 class="mb-4">Qu·∫£n l√Ω ƒë∆°n h√†ng</h3>
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>M√£ ƒë∆°n</th>
                            <th>Kh√°ch h√†ng</th>
                            <th>Ng√†y ƒë·∫∑t</th>
                            <th>T·ªïng ti·ªÅn</th>
                            <th>Thao t√°c</th>
                        </tr>
                    </thead>
                    <tbody id="ordersTable"></tbody>
                </table>
            </div>
        </div>

        <!-- Reviews Section -->
        <div id="reviews" class="content-section">
            <h3 class="mb-4">Qu·∫£n l√Ω ƒë√°nh gi√°</h3>
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>Ti√™u ƒë·ªÅ</th>
                            <th>N·ªôi dung</th>
                            <th>S·ªë sao</th>
                            <th>S·∫£n ph·∫©m</th>
                            <th>Tr·∫°ng th√°i</th>
                            <th>Ng√†y t·∫°o</th>
                            <th>Thao t√°c</th>
                        </tr>
                    </thead>
                    <tbody id="reviewsTable"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal Th√™m/S·ª≠a S·∫£n ph·∫©m -->
    <div class="modal fade" id="productModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="productModalTitle">Th√™m s·∫£n ph·∫©m m·ªõi</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="productForm">
                        <input type="hidden" id="productId">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">T√™n s·∫£n ph·∫©m *</label>
                                <input type="text" class="form-control" id="productName" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Gi√° *</label>
                                <input type="number" class="form-control" id="productPrice" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">S·ªë l∆∞·ª£ng</label>
                                <input type="number" class="form-control" id="productStock" value="0">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Th∆∞∆°ng hi·ªáu</label>
                                <select class="form-select" id="productBrand">
                                    <option value="Nike">Nike</option>
                                    <option value="Adidas">Adidas</option>
                                    <option value="Puma">Puma</option>
                                    <option value="Mizuno">Mizuno</option>
                                    <option value="Kamito">Kamito</option>
                                    <option value="Zocker">Zocker</option>
                                    <option value="Kh√°c">Kh√°c</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Lo·∫°i s√¢n</label>
                                <select class="form-select" id="productType">
                                    <option value="S√¢n c·ªè nh√¢n t·∫°o">S√¢n c·ªè nh√¢n t·∫°o</option>
                                    <option value="S√¢n c·ªè t·ª± nhi√™n">S√¢n c·ªè t·ª± nhi√™n</option>
                                    <option value="S√¢n Futsal">S√¢n Futsal</option>
                                    <option value="Kh√°c">Kh√°c</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">URL H√¨nh ·∫£nh</label>
                                <input type="text" class="form-control" id="productImage" placeholder="/images/product.jpg">
                            </div>
                            <div class="col-12 mb-3">
                                <label class="form-label">M√¥ t·∫£</label>
                                <textarea class="form-control" id="productDescription" rows="3"></textarea>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                    <button type="button" class="btn btn-primary" onclick="saveProduct()">
                        <i class="fas fa-save me-2"></i>L∆∞u
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        console.log('=== DEBUG INFO ===');
const token = localStorage.getItem('adminToken');
const admin = localStorage.getItem('admin');

console.log('Token:', token);
console.log('Admin:', admin);

if (token) {
  // Decode JWT ƒë·ªÉ xem role
  try {
    const payload = JSON.parse(atob(token.split('.')[1]));
    console.log('Token payload:', payload);
    console.log('Role:', payload.role);
  } catch (e) {
    console.error('Token decode error:', e);
  }
}
console.log('==================');

        const API_BASE_URL = window.location.hostname === 'localhost' 
            ? 'http://localhost:3000' 
            : 'https://sportzoneshop.onrender.com';

        let currentEditId = null;

        // ========== KI·ªÇM TRA ƒêƒÇNG NH·∫¨P ==========
        function checkAuth() {
             console.log('üîê Checking authentication...');
    
    const token = localStorage.getItem('adminToken');
    const admin = JSON.parse(localStorage.getItem('admin') || '{}');

    if (!token) {
        console.log('‚ùå No token found. Redirecting to login...');
        window.location.href = 'Admin_Login.html';
        return;
    }

    //  Verify token validity
    try {
        const payload = JSON.parse(atob(token.split('.')[1]));
        console.log('‚úÖ Token valid. Payload:', payload);
        
        //  Double-check MaVaiTro
        if (payload.MaVaiTro !== 0) {
            console.log('‚ùå Not an admin. MaVaiTro:', payload.MaVaiTro);
            localStorage.clear();
            window.location.href = 'Admin_Login.html';
            return;
        }
    } catch (e) {
        console.error('‚ùå Token decode failed:', e);
        localStorage.clear();
        window.location.href = 'Admin_Login.html';
        return;
    }

    //  Display admin info
    const adminName = admin.TenDangNhap || 'Admin';
    console.log('üë§ Admin name:', adminName);
    
    document.getElementById('adminName').textContent = adminName;
    document.getElementById('adminWelcome').textContent = adminName;
    
    console.log('‚úÖ Authentication check passed!');
        }

        // ========== ƒêƒÇNG XU·∫§T ==========
        function logout() {
            Swal.fire({
                title: 'X√°c nh·∫≠n ƒëƒÉng xu·∫•t?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'ƒêƒÉng xu·∫•t',
                cancelButtonText: 'H·ªßy',
                confirmButtonColor: '#667eea'
            }).then((result) => {
                if (result.isConfirmed) {
                    localStorage.removeItem('adminToken');
                    localStorage.removeItem('admin');
                    window.location.href = 'Admin_Login.html';
                }
            });
        }

        // ========== HI·ªÇN TH·ªä SECTION ==========
        function showSection(section) {
            document.querySelectorAll('.content-section').forEach(el => el.classList.remove('active'));
            document.getElementById(section).classList.add('active');

            document.querySelectorAll('.sidebar-menu li').forEach(el => el.classList.remove('active'));
            event.currentTarget.classList.add('active');

            if (section === 'users') loadUsers();
            if (section === 'products') loadProducts();
            if (section === 'cart') loadCart();
            if (section === 'orders') loadOrders();
            if (section === 'reviews') loadReviews();
        }

        // ========== HEADERS V·ªöI TOKEN ==========
        function getHeaders() {
            const token = localStorage.getItem('adminToken');
    console.log(' Creating headers with token:', token ? '‚úÖ Present' : '‚ùå Missing');
    
    return {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
    };
        }

        // ========== TH·ªêNG K√ä ==========
        async function loadStats() {
           try {
        console.log('üìä Loading admin stats...');
        console.log('üåê API URL:', API_BASE_URL);
        
        const res = await fetch(API_BASE_URL + '/api/admin/stats', {
            headers: getHeaders()
        });

        console.log('üì® Response status:', res.status);

        if (res.ok) {
            const stats = await res.json();
            console.log('‚úÖ Stats loaded:', stats);
                    document.getElementById('totalUsers').textContent = stats.totalUsers;
                    document.getElementById('totalProducts').textContent = stats.totalProducts;
                    document.getElementById('totalOrders').textContent = stats.totalOrders;
                    document.getElementById('totalCart').textContent = stats.totalCart;
                    document.getElementById('totalReviews').textContent = stats.totalReviews;
                    document.getElementById('totalRevenue').textContent = 
                        stats.totalRevenue.toLocaleString() + 'ƒë';
                }
            } catch (err) {
                console.error('L·ªói t·∫£i th·ªëng k√™:', err);
            }
        }

        // ========== NG∆Ø·ªúI D√ôNG ==========
        async function loadUsers() {
            try {
                const res = await fetch(API_BASE_URL + '/api/admin/users', {
                    headers: getHeaders()
                });

                if (res.ok) {
                    const users = await res.json();
                    const tbody = document.getElementById('usersTable');
                    tbody.innerHTML = users.map(user => `
                        <tr>
                            <td>${user.TenDangNhap}</td>
                            <td>${user.Email}</td>
                            <td>
                                <span class="badge ${user.MaVaiTro === 0 ? 'bg-danger' : 'bg-primary'}">
                                    ${user.MaVaiTro === 0 ? 'Admin' : 'Kh√°ch h√†ng'}
                                </span>
                            </td>
                            <td>${new Date(user.NgayTao).toLocaleDateString('vi-VN')}</td>
                            <td class="table-actions">
                                <button class="btn btn-sm btn-danger" onclick="deleteUser('${user._id}')" 
                                    ${user.MaVaiTro === 0 ? 'disabled title="Kh√¥ng th·ªÉ x√≥a admin"' : ''}>
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (err) {
                console.error('L·ªói t·∫£i ng∆∞·ªùi d√πng:', err);
            }
        }

        async function deleteUser(id) {
            const result = await Swal.fire({
                title: 'X√°c nh·∫≠n x√≥a?',
                text: 'B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ng∆∞·ªùi d√πng n√†y?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'X√≥a',
                cancelButtonText: 'H·ªßy',
                confirmButtonColor: '#e74c3c'
            });

            if (result.isConfirmed) {
                try {
                    const res = await fetch(API_BASE_URL + `/api/admin/users/${id}`, {
                        method: 'DELETE',
                        headers: getHeaders()
                    });

                    if (res.ok) {
                        Swal.fire('Th√†nh c√¥ng!', 'ƒê√£ x√≥a ng∆∞·ªùi d√πng', 'success');
                        loadUsers();
                        loadStats();
                    }
                } catch (err) {
                    Swal.fire('L·ªói!', 'Kh√¥ng th·ªÉ x√≥a ng∆∞·ªùi d√πng', 'error');
                }
            }
        }

        // ========== S·∫¢N PH·∫®M ==========
        async function loadProducts() {
            try {
                const res = await fetch(API_BASE_URL + '/api/sanpham');
                if (res.ok) {
                    const products = await res.json();
                    const tbody = document.getElementById('productsTable');
                    tbody.innerHTML = products.map(sp => `
                        <tr>
                            <td><img src="${sp.hinhAnh || '/images/default.jpg'}" class="product-img-preview"></td>
                            <td>${sp.ten}</td>
                            <td><strong>${Number(sp.gia).toLocaleString()}ƒë</strong></td>
                            <td>${sp.soLuong || 0}</td>
                            <td><span class="badge bg-info">${sp.thuongHieu || 'N/A'}</span></td>
                            <td><span class="badge bg-secondary">${sp.loai || 'N/A'}</span></td>
                            <td class="table-actions">
                                <button class="btn btn-sm btn-warning" onclick="editProduct('${sp._id}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteProduct('${sp._id}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (err) {
                console.error('L·ªói t·∫£i s·∫£n ph·∫©m:', err);
            }
        }

        function showAddProductModal() {
            currentEditId = null;
            document.getElementById('productModalTitle').textContent = 'Th√™m s·∫£n ph·∫©m m·ªõi';
            document.getElementById('productForm').reset();
            new bootstrap.Modal(document.getElementById('productModal')).show();
        }

        async function editProduct(id) {
            try {
                const res = await fetch(API_BASE_URL + `/api/admin/sanpham/${id}`, {
                    headers: getHeaders()
                });

                if (res.ok) {
                    const sp = await res.json();
                    currentEditId = id;
                    document.getElementById('productModalTitle').textContent = 'S·ª≠a s·∫£n ph·∫©m';
                    document.getElementById('productName').value = sp.ten;
                    document.getElementById('productPrice').value = sp.gia;
                    document.getElementById('productStock').value = sp.soLuong || 0;
                    document.getElementById('productBrand').value = sp.thuongHieu || 'Kh√°c';
                    document.getElementById('productType').value = sp.loai || 'Kh√°c';
                    document.getElementById('productImage').value = sp.hinhAnh || '';
                    document.getElementById('productDescription').value = sp.moTa || '';
                    
                    new bootstrap.Modal(document.getElementById('productModal')).show();
                }
            } catch (err) {
                Swal.fire('L·ªói!', 'Kh√¥ng th·ªÉ t·∫£i th√¥ng tin s·∫£n ph·∫©m', 'error');
            }
        }

        async function saveProduct() {
            const data = {
                ten: document.getElementById('productName').value,
                gia: document.getElementById('productPrice').value,
                soLuong: document.getElementById('productStock').value,
                thuongHieu: document.getElementById('productBrand').value,
                loai: document.getElementById('productType').value,
                hinhAnh: document.getElementById('productImage').value,
                moTa: document.getElementById('productDescription').value
            };

            try {
                const url = currentEditId 
                    ? API_BASE_URL + `/api/admin/sanpham/${currentEditId}`
                    : API_BASE_URL + '/api/admin/sanpham';
                
                const res = await fetch(url, {
                    method: currentEditId ? 'PUT' : 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify(data)
                });

                if (res.ok) {
                    Swal.fire('Th√†nh c√¥ng!', currentEditId ? 'ƒê√£ c·∫≠p nh·∫≠t s·∫£n ph·∫©m' : 'ƒê√£ th√™m s·∫£n ph·∫©m', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('productModal')).hide();
                    loadProducts();
                    loadStats();
                } else {
                    Swal.fire('L·ªói!', 'Kh√¥ng th·ªÉ l∆∞u s·∫£n ph·∫©m', 'error');
                }
            } catch (err) {
                Swal.fire('L·ªói!', 'Kh√¥ng th·ªÉ k·∫øt n·ªëi server', 'error');
            }
        }

        async function deleteProduct(id) {
            const result = await Swal.fire({
                title: 'X√°c nh·∫≠n x√≥a?',
                text: 'B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a s·∫£n ph·∫©m n√†y?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'X√≥a',
                cancelButtonText: 'H·ªßy',
                confirmButtonColor: '#e74c3c'
            });

            if (result.isConfirmed) {
                try {
                    const res = await fetch(API_BASE_URL + `/api/admin/sanpham/${id}`, {
                        method: 'DELETE',
                        headers: getHeaders()
                    });

                    if (res.ok) {
                        Swal.fire('Th√†nh c√¥ng!', 'ƒê√£ x√≥a s·∫£n ph·∫©m', 'success');
                        loadProducts();
                        loadStats();
                    }
                } catch (err) {
                    Swal.fire('L·ªói!', 'Kh√¥ng th·ªÉ x√≥a s·∫£n ph·∫©m', 'error');
                }
            }
        }

        // ========== GI·ªé H√ÄNG ==========
        async function loadCart() {
            try {
                const res = await fetch(API_BASE_URL + '/api/admin/giohang', {
                    headers: getHeaders()
                });

                if (res.ok) {
                    const carts = await res.json();
                    const tbody = document.getElementById('cartTable');
                    
                    if (carts.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">Ch∆∞a c√≥ gi·ªè h√†ng n√†o</td></tr>';
                        return;
                    }
                    
                    tbody.innerHTML = carts.map(item => `
                        <tr>
                            <td>${item.MaKhachHang}</td>
                            <td>${item.MaSanPham?.ten || 'N/A'}</td>
                            <td><img src="${item.MaSanPham?.hinhAnh || '/images/default.jpg'}" class="product-img-preview"></td>
                            <td>${item.SoLuong}</td>
                            <td>${item.Size || 'N/A'}</td>
                            <td>${new Date(item.NgayTao).toLocaleDateString('vi-VN')}</td>
                            <td class="table-actions">
                                <button class="btn btn-sm btn-danger" onclick="deleteCart('${item._id}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (err) {
                console.error('L·ªói t·∫£i gi·ªè h√†ng:', err);
            }
        }

        async function deleteCart(id) {
            const result = await Swal.fire({
                title: 'X√°c nh·∫≠n x√≥a?',
                text: 'B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a gi·ªè h√†ng n√†y?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'X√≥a',
                cancelButtonText: 'H·ªßy',
                confirmButtonColor: '#e74c3c'
            });

            if (result.isConfirmed) {
                try {
                    const res = await fetch(API_BASE_URL + `/api/admin/giohang/${id}`, {
                        method: 'DELETE',
                        headers: getHeaders()
                    });

                    if (res.ok) {
                        Swal.fire('Th√†nh c√¥ng!', 'ƒê√£ x√≥a gi·ªè h√†ng', 'success');
                        loadCart();
                        loadStats();
                    }
                } catch (err) {
                    Swal.fire('L·ªói!', 'Kh√¥ng th·ªÉ x√≥a gi·ªè h√†ng', 'error');
                }
            }
        }

        // ========== ƒê∆†N H√ÄNG ==========
        async function loadOrders() {
            try {
                const res = await fetch(API_BASE_URL + '/api/admin/donhang', {
                    headers: getHeaders()
                });

                if (res.ok) {
                    const orders = await res.json();
                    const tbody = document.getElementById('ordersTable');
                    
                    if (orders.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Ch∆∞a c√≥ ƒë∆°n h√†ng n√†o</td></tr>';
                        return;
                    }
                    
                    tbody.innerHTML = orders.map(order => `
                        <tr>
                            <td><code>${order._id.substring(0, 8)}...</code></td>
                            <td>${order.khachHang || 'N/A'}</td>
                            <td>${order.ngayDat ? new Date(order.ngayDat).toLocaleDateString('vi-VN') : 'N/A'}</td>
                            <td><strong class="text-success">${Number(order.tongTien || 0).toLocaleString()}ƒë</strong></td>
                            <td class="table-actions">
                                <button class="btn btn-sm btn-info" onclick="viewOrder('${order._id}')">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteOrder('${order._id}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (err) {
                console.error('L·ªói t·∫£i ƒë∆°n h√†ng:', err);
            }
        }

        async function viewOrder(id) {
            try {
                const res = await fetch(API_BASE_URL + `/api/admin/donhang/${id}`, {
                    headers: getHeaders()
                });

                if (res.ok) {
                    const order = await res.json();
                    Swal.fire({
                        title: 'Chi ti·∫øt ƒë∆°n h√†ng',
                        html: `
                            <div class="text-start">
                                <p><strong>M√£ ƒë∆°n:</strong> <code>${order._id}</code></p>
                                <p><strong>Kh√°ch h√†ng:</strong> ${order.khachHang || 'N/A'}</p>
                                <p><strong>Ng√†y ƒë·∫∑t:</strong> ${order.ngayDat ? new Date(order.ngayDat).toLocaleString('vi-VN') : 'N/A'}</p>
                                <p><strong>T·ªïng ti·ªÅn:</strong> <span class="text-success fw-bold">${Number(order.tongTien || 0).toLocaleString()}ƒë</span></p>
                            </div>
                        `,
                        confirmButtonColor: '#667eea',
                        width: '600px'
                    });
                }
            } catch (err) {
                Swal.fire('L·ªói!', 'Kh√¥ng th·ªÉ t·∫£i chi ti·∫øt ƒë∆°n h√†ng', 'error');
            }
        }

        async function deleteOrder(id) {
            const result = await Swal.fire({
                title: 'X√°c nh·∫≠n x√≥a?',
                text: 'B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ƒë∆°n h√†ng n√†y?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'X√≥a',
                cancelButtonText: 'H·ªßy',
                confirmButtonColor: '#e74c3c'
            });

            if (result.isConfirmed) {
                try {
                    const res = await fetch(API_BASE_URL + `/api/admin/donhang/${id}`, {
                        method: 'DELETE',
                        headers: getHeaders()
                    });

                    if (res.ok) {
                        Swal.fire('Th√†nh c√¥ng!', 'ƒê√£ x√≥a ƒë∆°n h√†ng', 'success');
                        loadOrders();
                        loadStats();
                    }
                } catch (err) {
                    Swal.fire('L·ªói!', 'Kh√¥ng th·ªÉ x√≥a ƒë∆°n h√†ng', 'error');
                }
            }
        }

        // ========== ƒê√ÅNH GI√Å ==========
        async function loadReviews() {
            try {
                const res = await fetch(API_BASE_URL + '/api/admin/danhgia', {
                    headers: getHeaders()
                });

                if (res.ok) {
                    const reviews = await res.json();
                    const tbody = document.getElementById('reviewsTable');
                    
                    if (reviews.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">Ch∆∞a c√≥ ƒë√°nh gi√° n√†o</td></tr>';
                        return;
                    }
                    
                    tbody.innerHTML = reviews.map(review => `
                        <tr>
                            <td><strong>${review.TieuDe || 'N/A'}</strong></td>
                            <td>${(review.NoiDung || '').substring(0, 50)}${review.NoiDung?.length > 50 ? '...' : ''}</td>
                            <td>
                                <span style="color: #f39c12;">
                                    ${'‚òÖ'.repeat(review.SoSao || 0)}${'‚òÜ'.repeat(5 - (review.SoSao || 0))}
                                </span>
                                <br>
                                <small class="text-muted">(${review.SoSao}/5)</small>
                            </td>
                            <td><small>${review.MaSanPham || 'N/A'}</small></td>
                            <td>
                                <span class="badge ${review.TrangThai === 1 ? 'bg-success' : 'bg-warning'}">
                                    ${review.TrangThai === 1 ? 'Hi·ªÉn th·ªã' : '·∫®n'}
                                </span>
                            </td>
                            <td>${review.NgayTao ? new Date(review.NgayTao).toLocaleDateString('vi-VN') : 'N/A'}</td>
                            <td class="table-actions">
                                <button class="btn btn-sm btn-info" onclick="viewReview('${review._id}')" title="Xem chi ti·∫øt">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm ${review.TrangThai === 1 ? 'btn-warning' : 'btn-success'}" 
                                    onclick="toggleReviewStatus('${review._id}', ${review.TrangThai})"
                                    title="${review.TrangThai === 1 ? '·∫®n' : 'Hi·ªÉn th·ªã'}">
                                    <i class="fas fa-${review.TrangThai === 1 ? 'eye-slash' : 'eye'}"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteReview('${review._id}')" title="X√≥a">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (err) {
                console.error('L·ªói t·∫£i ƒë√°nh gi√°:', err);
            }
        }

        async function viewReview(id) {
            try {
                const res = await fetch(API_BASE_URL + '/api/admin/danhgia', {
                    headers: getHeaders()
                });

                if (res.ok) {
                    const reviews = await res.json();
                    const review = reviews.find(r => r._id === id);
                    
                    if (review) {
                        const stars = '‚òÖ'.repeat(review.SoSao || 0) + '‚òÜ'.repeat(5 - (review.SoSao || 0));
                        Swal.fire({
                            title: 'Chi ti·∫øt ƒë√°nh gi√°',
                            html: `
                                <div class="text-start" style="padding: 10px;">
                                    <div class="mb-3">
                                        <strong>Ti√™u ƒë·ªÅ:</strong>
                                        <p class="mb-0">${review.TieuDe || 'N/A'}</p>
                                    </div>
                                    <div class="mb-3">
                                        <strong>N·ªôi dung:</strong>
                                        <p class="mb-0" style="white-space: pre-wrap;">${review.NoiDung || 'N/A'}</p>
                                    </div>
                                    <div class="mb-3">
                                        <strong>S·ªë sao:</strong>
                                        <p class="mb-0" style="color: #f39c12; font-size: 20px;">${stars} (${review.SoSao}/5)</p>
                                    </div>
                                    <div class="mb-3">
                                        <strong>S·∫£n ph·∫©m:</strong>
                                        <p class="mb-0"><code>${review.MaSanPham || 'N/A'}</code></p>
                                    </div>
                                    <div class="mb-3">
                                        <strong>Kh√°ch h√†ng:</strong>
                                        <p class="mb-0">${review.MaKhachHang || 'N/A'}</p>
                                    </div>
                                    <div class="mb-3">
                                        <strong>Tr·∫°ng th√°i:</strong>
                                        <p class="mb-0">
                                            <span class="badge ${review.TrangThai === 1 ? 'bg-success' : 'bg-warning'}">
                                                ${review.TrangThai === 1 ? 'Hi·ªÉn th·ªã' : '·∫®n'}
                                            </span>
                                        </p>
                                    </div>
                                    <div class="mb-3">
                                        <strong>Ng√†y t·∫°o:</strong>
                                        <p class="mb-0">${review.NgayTao ? new Date(review.NgayTao).toLocaleString('vi-VN') : 'N/A'}</p>
                                    </div>
                                </div>
                            `,
                            confirmButtonColor: '#667eea',
                            width: '600px'
                        });
                    }
                }
            } catch (err) {
                Swal.fire('L·ªói!', 'Kh√¥ng th·ªÉ t·∫£i chi ti·∫øt ƒë√°nh gi√°', 'error');
            }
        }

        async function toggleReviewStatus(id, currentStatus) {
            const newStatus = currentStatus === 1 ? 0 : 1;
            
            try {
                const res = await fetch(API_BASE_URL + `/api/admin/danhgia/${id}/status`, {
                    method: 'PATCH',
                    headers: getHeaders(),
                    body: JSON.stringify({ TrangThai: newStatus })
                });

                if (res.ok) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Th√†nh c√¥ng!',
                        text: `ƒê√£ ${newStatus === 1 ? 'hi·ªÉn th·ªã' : '·∫©n'} ƒë√°nh gi√°`,
                        timer: 1500,
                        showConfirmButton: false
                    });
                    loadReviews();
                }
            } catch (err) {
                Swal.fire('L·ªói!', 'Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i', 'error');
            }
        }

        async function deleteReview(id) {
            const result = await Swal.fire({
                title: 'X√°c nh·∫≠n x√≥a?',
                text: 'B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ƒë√°nh gi√° n√†y?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'X√≥a',
                cancelButtonText: 'H·ªßy',
                confirmButtonColor: '#e74c3c'
            });

            if (result.isConfirmed) {
                try {
                    const res = await fetch(API_BASE_URL + `/api/admin/danhgia/${id}`, {
                        method: 'DELETE',
                        headers: getHeaders()
                    });

                    if (res.ok) {
                        Swal.fire('Th√†nh c√¥ng!', 'ƒê√£ x√≥a ƒë√°nh gi√°', 'success');
                        loadReviews();
                        loadStats();
                    }
                } catch (err) {
                    Swal.fire('L·ªói!', 'Kh√¥ng th·ªÉ x√≥a ƒë√°nh gi√°', 'error');
                }
            }
        }

        // ========== KH·ªûI T·∫†O ==========
        checkAuth();
        loadStats();
    </script>
</body>
</html>