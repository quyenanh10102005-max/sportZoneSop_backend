<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - SportZoneVN</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f6fa;
        }
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            height: 100vh;
            width: 250px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px 0;
            overflow-y: auto;
            z-index: 1000;
        }
        .sidebar-logo {
            text-align: center;
            color: white;
            padding: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .sidebar-logo i {
            font-size: 40px;
            margin-bottom: 10px;
        }
        .sidebar-menu {
            list-style: none;
            padding: 20px 0;
        }
        .sidebar-menu li {
            padding: 15px 25px;
            cursor: pointer;
            transition: all 0.3s;
            color: rgba(255,255,255,0.8);
        }
        .sidebar-menu li:hover,
        .sidebar-menu li.active {
            background: rgba(255,255,255,0.1);
            color: white;
            border-left: 4px solid white;
        }
        .sidebar-menu li i {
            margin-right: 10px;
            width: 20px;
        }
        .main-content {
            margin-left: 250px;
            padding: 20px;
        }
        .top-bar {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }
        .stat-card:hover {
            transform: translateY(-5px);
        }
        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            margin-bottom: 15px;
        }
        .stat-card h3 {
            font-size: 32px;
            font-weight: bold;
            margin: 10px 0;
        }
        .stat-card p {
            color: #7f8c8d;
            margin: 0;
        }
        .content-section {
            display: none;
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .content-section.active {
            display: block;
        }
        .table-actions button {
            margin: 0 2px;
            padding: 5px 10px;
        }
        .btn-logout {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 5px;
        }
        .btn-logout:hover {
            background: #c0392b;
        }
        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .product-img-preview {
            max-width: 80px;
            max-height: 80px;
            object-fit: cover;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-logo">
            <i class="fas fa-user-shield"></i>
            <h4>Admin Panel</h4>
            <p id="adminName" style="font-size: 14px; opacity: 0.8;"></p>
        </div>
        <ul class="sidebar-menu">
            <li class="active" onclick="showSection('dashboard')">
                <i class="fas fa-tachometer-alt"></i>Dashboard
            </li>
            <li onclick="showSection('users')">
                <i class="fas fa-users"></i>Người dùng
            </li>
            <li onclick="showSection('products')">
                <i class="fas fa-box"></i>Sản phẩm
            </li>
            <li onclick="showSection('cart')">
                <i class="fas fa-shopping-cart"></i>Giỏ hàng
            </li>
            <li onclick="showSection('orders')">
                <i class="fas fa-receipt"></i>Đơn hàng
            </li>
            <li onclick="showSection('reviews')">
                <i class="fas fa-star"></i>Đánh giá
            </li>
        </ul>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Top Bar -->
        <div class="top-bar">
            <h2>Chào mừng, <span id="adminWelcome"></span>!</h2>
            <button class="btn-logout" onclick="logout()">
                <i class="fas fa-sign-out-alt me-2"></i>Đăng xuất
            </button>
        </div>

        <!-- Dashboard Section -->
        <div id="dashboard" class="content-section active">
            <h3 class="mb-4">Thống kê tổng quan</h3>
            <div class="stats-container">
                <div class="stat-card">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        <i class="fas fa-users"></i>
                    </div>
                    <h3 id="totalUsers">0</h3>
                    <p>Tổng người dùng</p>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                        <i class="fas fa-box"></i>
                    </div>
                    <h3 id="totalProducts">0</h3>
                    <p>Tổng sản phẩm</p>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                        <i class="fas fa-shopping-cart"></i>
                    </div>
                    <h3 id="totalCart">0</h3>
                    <p>Giỏ hàng</p>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                        <i class="fas fa-receipt"></i>
                    </div>
                    <h3 id="totalOrders">0</h3>
                    <p>Đơn hàng</p>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                        <i class="fas fa-star"></i>
                    </div>
                    <h3 id="totalReviews">0</h3>
                    <p>Đánh giá</p>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #30cfd0 0%, #330867 100%);">
                        <i class="fas fa-dollar-sign"></i>
                    </div>
                    <h3 id="totalRevenue">0đ</h3>
                    <p>Doanh thu</p>
                </div>
            </div>
        </div>

        <!-- Users Section -->
        <div id="users" class="content-section">
            <h3 class="mb-4">Quản lý người dùng</h3>
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>Tên đăng nhập</th>
                            <th>Email</th>
                            <th>Vai trò</th>
                            <th>Ngày tạo</th>
                            <th>Thao tác</th>
                        </tr>
                    </thead>
                    <tbody id="usersTable"></tbody>
                </table>
            </div>
        </div>

        <!-- Products Section -->
        <div id="products" class="content-section">
            <div class="d-flex justify-content-between mb-4">
                <h3>Quản lý sản phẩm</h3>
                <button class="btn btn-primary" onclick="showAddProductModal()">
                    <i class="fas fa-plus me-2"></i>Thêm sản phẩm
                </button>
            </div>
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>Hình ảnh</th>
                            <th>Tên sản phẩm</th>
                            <th>Giá</th>
                            <th>Số lượng</th>
                            <th>Thương hiệu</th>
                            <th>Loại</th>
                            <th>Thao tác</th>
                        </tr>
                    </thead>
                    <tbody id="productsTable"></tbody>
                </table>
            </div>
        </div>

        <!-- Cart Section -->
        <div id="cart" class="content-section">
            <h3 class="mb-4">Quản lý giỏ hàng</h3>
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>Khách hàng</th>
                            <th>Sản phẩm</th>
                            <th>Hình ảnh</th>
                            <th>Số lượng</th>
                            <th>Size</th>
                            <th>Ngày thêm</th>
                            <th>Thao tác</th>
                        </tr>
                    </thead>
                    <tbody id="cartTable"></tbody>
                </table>
            </div>
        </div>

        <!-- Orders Section -->
        <div id="orders" class="content-section">
            <h3 class="mb-4">Quản lý đơn hàng</h3>
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>Mã đơn</th>
                            <th>Khách hàng</th>
                            <th>Ngày đặt</th>
                            <th>Tổng tiền</th>
                            <th>Thao tác</th>
                        </tr>
                    </thead>
                    <tbody id="ordersTable"></tbody>
                </table>
            </div>
        </div>

        <!-- Reviews Section -->
        <div id="reviews" class="content-section">
            <h3 class="mb-4">Quản lý đánh giá</h3>
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>Tiêu đề</th>
                            <th>Nội dung</th>
                            <th>Số sao</th>
                            <th>Sản phẩm</th>
                            <th>Trạng thái</th>
                            <th>Ngày tạo</th>
                            <th>Thao tác</th>
                        </tr>
                    </thead>
                    <tbody id="reviewsTable"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal Thêm/Sửa Sản phẩm -->
    <div class="modal fade" id="productModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="productModalTitle">Thêm sản phẩm mới</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="productForm">
                        <input type="hidden" id="productId">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Tên sản phẩm *</label>
                                <input type="text" class="form-control" id="productName" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Giá *</label>
                                <input type="number" class="form-control" id="productPrice" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Số lượng</label>
                                <input type="number" class="form-control" id="productStock" value="0">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Thương hiệu</label>
                                <select class="form-select" id="productBrand">
                                    <option value="Nike">Nike</option>
                                    <option value="Adidas">Adidas</option>
                                    <option value="Puma">Puma</option>
                                    <option value="Mizuno">Mizuno</option>
                                    <option value="Kamito">Kamito</option>
                                    <option value="Zocker">Zocker</option>
                                    <option value="Khác">Khác</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Loại sân</label>
                                <select class="form-select" id="productType">
                                    <option value="Sân cỏ nhân tạo">Sân cỏ nhân tạo</option>
                                    <option value="Sân cỏ tự nhiên">Sân cỏ tự nhiên</option>
                                    <option value="Sân Futsal">Sân Futsal</option>
                                    <option value="Khác">Khác</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">URL Hình ảnh</label>
                                <input type="text" class="form-control" id="productImage" placeholder="/images/product.jpg">
                            </div>
                            <div class="col-12 mb-3">
                                <label class="form-label">Mô tả</label>
                                <textarea class="form-control" id="productDescription" rows="3"></textarea>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-primary" onclick="saveProduct()">
                        <i class="fas fa-save me-2"></i>Lưu
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        console.log('=== DEBUG INFO ===');
const token = localStorage.getItem('adminToken');
const admin = localStorage.getItem('admin');

console.log('Token:', token);
console.log('Admin:', admin);

if (token) {
  // Decode JWT để xem role
  try {
    const payload = JSON.parse(atob(token.split('.')[1]));
    console.log('Token payload:', payload);
    console.log('Role:', payload.role);
  } catch (e) {
    console.error('Token decode error:', e);
  }
}
console.log('==================');

        const API_BASE_URL = window.location.hostname === 'localhost' 
            ? 'http://localhost:3000' 
            : 'https://sportzoneshop.onrender.com';

        let currentEditId = null;

        // ========== KIỂM TRA ĐĂNG NHẬP ==========
        function checkAuth() {
            const token = localStorage.getItem('adminToken');
            const admin = JSON.parse(localStorage.getItem('admin') || '{}');

            if (!token) {
                window.location.href = 'Admin_Login.html';
                return;
            }

            document.getElementById('adminName').textContent = admin.TenDangNhap || 'Admin';
            document.getElementById('adminWelcome').textContent = admin.TenDangNhap || 'Admin';
        }

        // ========== ĐĂNG XUẤT ==========
        function logout() {
            Swal.fire({
                title: 'Xác nhận đăng xuất?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Đăng xuất',
                cancelButtonText: 'Hủy',
                confirmButtonColor: '#667eea'
            }).then((result) => {
                if (result.isConfirmed) {
                    localStorage.removeItem('adminToken');
                    localStorage.removeItem('admin');
                    window.location.href = 'Admin_Login.html';
                }
            });
        }

        // ========== HIỂN THỊ SECTION ==========
        function showSection(section) {
            document.querySelectorAll('.content-section').forEach(el => el.classList.remove('active'));
            document.getElementById(section).classList.add('active');

            document.querySelectorAll('.sidebar-menu li').forEach(el => el.classList.remove('active'));
            event.currentTarget.classList.add('active');

            if (section === 'users') loadUsers();
            if (section === 'products') loadProducts();
            if (section === 'cart') loadCart();
            if (section === 'orders') loadOrders();
            if (section === 'reviews') loadReviews();
        }

        // ========== HEADERS VỚI TOKEN ==========
        function getHeaders() {
            const token = localStorage.getItem('adminToken');
            return {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            };
        }

        // ========== THỐNG KÊ ==========
        async function loadStats() {
            try {
                const res = await fetch(API_BASE_URL + '/api/admin/stats', {
                    headers: getHeaders()
                });

                if (res.ok) {
                    const stats = await res.json();
                    document.getElementById('totalUsers').textContent = stats.totalUsers;
                    document.getElementById('totalProducts').textContent = stats.totalProducts;
                    document.getElementById('totalOrders').textContent = stats.totalOrders;
                    document.getElementById('totalCart').textContent = stats.totalCart;
                    document.getElementById('totalReviews').textContent = stats.totalReviews;
                    document.getElementById('totalRevenue').textContent = 
                        stats.totalRevenue.toLocaleString() + 'đ';
                }
            } catch (err) {
                console.error('Lỗi tải thống kê:', err);
            }
        }

        // ========== NGƯỜI DÙNG ==========
        async function loadUsers() {
            try {
                const res = await fetch(API_BASE_URL + '/api/admin/users', {
                    headers: getHeaders()
                });

                if (res.ok) {
                    const users = await res.json();
                    const tbody = document.getElementById('usersTable');
                    tbody.innerHTML = users.map(user => `
                        <tr>
                            <td>${user.TenDangNhap}</td>
                            <td>${user.Email}</td>
                            <td>
                                <span class="badge ${user.MaVaiTro === 0 ? 'bg-danger' : 'bg-primary'}">
                                    ${user.MaVaiTro === 0 ? 'Admin' : 'Khách hàng'}
                                </span>
                            </td>
                            <td>${new Date(user.NgayTao).toLocaleDateString('vi-VN')}</td>
                            <td class="table-actions">
                                <button class="btn btn-sm btn-danger" onclick="deleteUser('${user._id}')" 
                                    ${user.MaVaiTro === 0 ? 'disabled title="Không thể xóa admin"' : ''}>
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (err) {
                console.error('Lỗi tải người dùng:', err);
            }
        }

        async function deleteUser(id) {
            const result = await Swal.fire({
                title: 'Xác nhận xóa?',
                text: 'Bạn có chắc muốn xóa người dùng này?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Xóa',
                cancelButtonText: 'Hủy',
                confirmButtonColor: '#e74c3c'
            });

            if (result.isConfirmed) {
                try {
                    const res = await fetch(API_BASE_URL + `/api/admin/users/${id}`, {
                        method: 'DELETE',
                        headers: getHeaders()
                    });

                    if (res.ok) {
                        Swal.fire('Thành công!', 'Đã xóa người dùng', 'success');
                        loadUsers();
                        loadStats();
                    }
                } catch (err) {
                    Swal.fire('Lỗi!', 'Không thể xóa người dùng', 'error');
                }
            }
        }

        // ========== SẢN PHẨM ==========
        async function loadProducts() {
            try {
                const res = await fetch(API_BASE_URL + '/api/sanpham');
                if (res.ok) {
                    const products = await res.json();
                    const tbody = document.getElementById('productsTable');
                    tbody.innerHTML = products.map(sp => `
                        <tr>
                            <td><img src="${sp.hinhAnh || '/images/default.jpg'}" class="product-img-preview"></td>
                            <td>${sp.ten}</td>
                            <td><strong>${Number(sp.gia).toLocaleString()}đ</strong></td>
                            <td>${sp.soLuong || 0}</td>
                            <td><span class="badge bg-info">${sp.thuongHieu || 'N/A'}</span></td>
                            <td><span class="badge bg-secondary">${sp.loai || 'N/A'}</span></td>
                            <td class="table-actions">
                                <button class="btn btn-sm btn-warning" onclick="editProduct('${sp._id}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteProduct('${sp._id}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (err) {
                console.error('Lỗi tải sản phẩm:', err);
            }
        }

        function showAddProductModal() {
            currentEditId = null;
            document.getElementById('productModalTitle').textContent = 'Thêm sản phẩm mới';
            document.getElementById('productForm').reset();
            new bootstrap.Modal(document.getElementById('productModal')).show();
        }

        async function editProduct(id) {
            try {
                const res = await fetch(API_BASE_URL + `/api/admin/sanpham/${id}`, {
                    headers: getHeaders()
                });

                if (res.ok) {
                    const sp = await res.json();
                    currentEditId = id;
                    document.getElementById('productModalTitle').textContent = 'Sửa sản phẩm';
                    document.getElementById('productName').value = sp.ten;
                    document.getElementById('productPrice').value = sp.gia;
                    document.getElementById('productStock').value = sp.soLuong || 0;
                    document.getElementById('productBrand').value = sp.thuongHieu || 'Khác';
                    document.getElementById('productType').value = sp.loai || 'Khác';
                    document.getElementById('productImage').value = sp.hinhAnh || '';
                    document.getElementById('productDescription').value = sp.moTa || '';
                    
                    new bootstrap.Modal(document.getElementById('productModal')).show();
                }
            } catch (err) {
                Swal.fire('Lỗi!', 'Không thể tải thông tin sản phẩm', 'error');
            }
        }

        async function saveProduct() {
            const data = {
                ten: document.getElementById('productName').value,
                gia: document.getElementById('productPrice').value,
                soLuong: document.getElementById('productStock').value,
                thuongHieu: document.getElementById('productBrand').value,
                loai: document.getElementById('productType').value,
                hinhAnh: document.getElementById('productImage').value,
                moTa: document.getElementById('productDescription').value
            };

            try {
                const url = currentEditId 
                    ? API_BASE_URL + `/api/admin/sanpham/${currentEditId}`
                    : API_BASE_URL + '/api/admin/sanpham';
                
                const res = await fetch(url, {
                    method: currentEditId ? 'PUT' : 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify(data)
                });

                if (res.ok) {
                    Swal.fire('Thành công!', currentEditId ? 'Đã cập nhật sản phẩm' : 'Đã thêm sản phẩm', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('productModal')).hide();
                    loadProducts();
                    loadStats();
                } else {
                    Swal.fire('Lỗi!', 'Không thể lưu sản phẩm', 'error');
                }
            } catch (err) {
                Swal.fire('Lỗi!', 'Không thể kết nối server', 'error');
            }
        }

        async function deleteProduct(id) {
            const result = await Swal.fire({
                title: 'Xác nhận xóa?',
                text: 'Bạn có chắc muốn xóa sản phẩm này?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Xóa',
                cancelButtonText: 'Hủy',
                confirmButtonColor: '#e74c3c'
            });

            if (result.isConfirmed) {
                try {
                    const res = await fetch(API_BASE_URL + `/api/admin/sanpham/${id}`, {
                        method: 'DELETE',
                        headers: getHeaders()
                    });

                    if (res.ok) {
                        Swal.fire('Thành công!', 'Đã xóa sản phẩm', 'success');
                        loadProducts();
                        loadStats();
                    }
                } catch (err) {
                    Swal.fire('Lỗi!', 'Không thể xóa sản phẩm', 'error');
                }
            }
        }

        // ========== GIỎ HÀNG ==========
        async function loadCart() {
            try {
                const res = await fetch(API_BASE_URL + '/api/admin/giohang', {
                    headers: getHeaders()
                });

                if (res.ok) {
                    const carts = await res.json();
                    const tbody = document.getElementById('cartTable');
                    
                    if (carts.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">Chưa có giỏ hàng nào</td></tr>';
                        return;
                    }
                    
                    tbody.innerHTML = carts.map(item => `
                        <tr>
                            <td>${item.MaKhachHang}</td>
                            <td>${item.MaSanPham?.ten || 'N/A'}</td>
                            <td><img src="${item.MaSanPham?.hinhAnh || '/images/default.jpg'}" class="product-img-preview"></td>
                            <td>${item.SoLuong}</td>
                            <td>${item.Size || 'N/A'}</td>
                            <td>${new Date(item.NgayTao).toLocaleDateString('vi-VN')}</td>
                            <td class="table-actions">
                                <button class="btn btn-sm btn-danger" onclick="deleteCart('${item._id}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (err) {
                console.error('Lỗi tải giỏ hàng:', err);
            }
        }

        async function deleteCart(id) {
            const result = await Swal.fire({
                title: 'Xác nhận xóa?',
                text: 'Bạn có chắc muốn xóa giỏ hàng này?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Xóa',
                cancelButtonText: 'Hủy',
                confirmButtonColor: '#e74c3c'
            });

            if (result.isConfirmed) {
                try {
                    const res = await fetch(API_BASE_URL + `/api/admin/giohang/${id}`, {
                        method: 'DELETE',
                        headers: getHeaders()
                    });

                    if (res.ok) {
                        Swal.fire('Thành công!', 'Đã xóa giỏ hàng', 'success');
                        loadCart();
                        loadStats();
                    }
                } catch (err) {
                    Swal.fire('Lỗi!', 'Không thể xóa giỏ hàng', 'error');
                }
            }
        }

        // ========== ĐƠN HÀNG ==========
        async function loadOrders() {
            try {
                const res = await fetch(API_BASE_URL + '/api/admin/donhang', {
                    headers: getHeaders()
                });

                if (res.ok) {
                    const orders = await res.json();
                    const tbody = document.getElementById('ordersTable');
                    
                    if (orders.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Chưa có đơn hàng nào</td></tr>';
                        return;
                    }
                    
                    tbody.innerHTML = orders.map(order => `
                        <tr>
                            <td><code>${order._id.substring(0, 8)}...</code></td>
                            <td>${order.khachHang || 'N/A'}</td>
                            <td>${order.ngayDat ? new Date(order.ngayDat).toLocaleDateString('vi-VN') : 'N/A'}</td>
                            <td><strong class="text-success">${Number(order.tongTien || 0).toLocaleString()}đ</strong></td>
                            <td class="table-actions">
                                <button class="btn btn-sm btn-info" onclick="viewOrder('${order._id}')">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteOrder('${order._id}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (err) {
                console.error('Lỗi tải đơn hàng:', err);
            }
        }

        async function viewOrder(id) {
            try {
                const res = await fetch(API_BASE_URL + `/api/admin/donhang/${id}`, {
                    headers: getHeaders()
                });

                if (res.ok) {
                    const order = await res.json();
                    Swal.fire({
                        title: 'Chi tiết đơn hàng',
                        html: `
                            <div class="text-start">
                                <p><strong>Mã đơn:</strong> <code>${order._id}</code></p>
                                <p><strong>Khách hàng:</strong> ${order.khachHang || 'N/A'}</p>
                                <p><strong>Ngày đặt:</strong> ${order.ngayDat ? new Date(order.ngayDat).toLocaleString('vi-VN') : 'N/A'}</p>
                                <p><strong>Tổng tiền:</strong> <span class="text-success fw-bold">${Number(order.tongTien || 0).toLocaleString()}đ</span></p>
                            </div>
                        `,
                        confirmButtonColor: '#667eea',
                        width: '600px'
                    });
                }
            } catch (err) {
                Swal.fire('Lỗi!', 'Không thể tải chi tiết đơn hàng', 'error');
            }
        }

        async function deleteOrder(id) {
            const result = await Swal.fire({
                title: 'Xác nhận xóa?',
                text: 'Bạn có chắc muốn xóa đơn hàng này?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Xóa',
                cancelButtonText: 'Hủy',
                confirmButtonColor: '#e74c3c'
            });

            if (result.isConfirmed) {
                try {
                    const res = await fetch(API_BASE_URL + `/api/admin/donhang/${id}`, {
                        method: 'DELETE',
                        headers: getHeaders()
                    });

                    if (res.ok) {
                        Swal.fire('Thành công!', 'Đã xóa đơn hàng', 'success');
                        loadOrders();
                        loadStats();
                    }
                } catch (err) {
                    Swal.fire('Lỗi!', 'Không thể xóa đơn hàng', 'error');
                }
            }
        }

        // ========== ĐÁNH GIÁ ==========
        async function loadReviews() {
            try {
                const res = await fetch(API_BASE_URL + '/api/admin/danhgia', {
                    headers: getHeaders()
                });

                if (res.ok) {
                    const reviews = await res.json();
                    const tbody = document.getElementById('reviewsTable');
                    
                    if (reviews.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">Chưa có đánh giá nào</td></tr>';
                        return;
                    }
                    
                    tbody.innerHTML = reviews.map(review => `
                        <tr>
                            <td><strong>${review.TieuDe || 'N/A'}</strong></td>
                            <td>${(review.NoiDung || '').substring(0, 50)}${review.NoiDung?.length > 50 ? '...' : ''}</td>
                            <td>
                                <span style="color: #f39c12;">
                                    ${'★'.repeat(review.SoSao || 0)}${'☆'.repeat(5 - (review.SoSao || 0))}
                                </span>
                                <br>
                                <small class="text-muted">(${review.SoSao}/5)</small>
                            </td>
                            <td><small>${review.MaSanPham || 'N/A'}</small></td>
                            <td>
                                <span class="badge ${review.TrangThai === 1 ? 'bg-success' : 'bg-warning'}">
                                    ${review.TrangThai === 1 ? 'Hiển thị' : 'Ẩn'}
                                </span>
                            </td>
                            <td>${review.NgayTao ? new Date(review.NgayTao).toLocaleDateString('vi-VN') : 'N/A'}</td>
                            <td class="table-actions">
                                <button class="btn btn-sm btn-info" onclick="viewReview('${review._id}')" title="Xem chi tiết">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm ${review.TrangThai === 1 ? 'btn-warning' : 'btn-success'}" 
                                    onclick="toggleReviewStatus('${review._id}', ${review.TrangThai})"
                                    title="${review.TrangThai === 1 ? 'Ẩn' : 'Hiển thị'}">
                                    <i class="fas fa-${review.TrangThai === 1 ? 'eye-slash' : 'eye'}"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteReview('${review._id}')" title="Xóa">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (err) {
                console.error('Lỗi tải đánh giá:', err);
            }
        }

        async function viewReview(id) {
            try {
                const res = await fetch(API_BASE_URL + '/api/admin/danhgia', {
                    headers: getHeaders()
                });

                if (res.ok) {
                    const reviews = await res.json();
                    const review = reviews.find(r => r._id === id);
                    
                    if (review) {
                        const stars = '★'.repeat(review.SoSao || 0) + '☆'.repeat(5 - (review.SoSao || 0));
                        Swal.fire({
                            title: 'Chi tiết đánh giá',
                            html: `
                                <div class="text-start" style="padding: 10px;">
                                    <div class="mb-3">
                                        <strong>Tiêu đề:</strong>
                                        <p class="mb-0">${review.TieuDe || 'N/A'}</p>
                                    </div>
                                    <div class="mb-3">
                                        <strong>Nội dung:</strong>
                                        <p class="mb-0" style="white-space: pre-wrap;">${review.NoiDung || 'N/A'}</p>
                                    </div>
                                    <div class="mb-3">
                                        <strong>Số sao:</strong>
                                        <p class="mb-0" style="color: #f39c12; font-size: 20px;">${stars} (${review.SoSao}/5)</p>
                                    </div>
                                    <div class="mb-3">
                                        <strong>Sản phẩm:</strong>
                                        <p class="mb-0"><code>${review.MaSanPham || 'N/A'}</code></p>
                                    </div>
                                    <div class="mb-3">
                                        <strong>Khách hàng:</strong>
                                        <p class="mb-0">${review.MaKhachHang || 'N/A'}</p>
                                    </div>
                                    <div class="mb-3">
                                        <strong>Trạng thái:</strong>
                                        <p class="mb-0">
                                            <span class="badge ${review.TrangThai === 1 ? 'bg-success' : 'bg-warning'}">
                                                ${review.TrangThai === 1 ? 'Hiển thị' : 'Ẩn'}
                                            </span>
                                        </p>
                                    </div>
                                    <div class="mb-3">
                                        <strong>Ngày tạo:</strong>
                                        <p class="mb-0">${review.NgayTao ? new Date(review.NgayTao).toLocaleString('vi-VN') : 'N/A'}</p>
                                    </div>
                                </div>
                            `,
                            confirmButtonColor: '#667eea',
                            width: '600px'
                        });
                    }
                }
            } catch (err) {
                Swal.fire('Lỗi!', 'Không thể tải chi tiết đánh giá', 'error');
            }
        }

        async function toggleReviewStatus(id, currentStatus) {
            const newStatus = currentStatus === 1 ? 0 : 1;
            
            try {
                const res = await fetch(API_BASE_URL + `/api/admin/danhgia/${id}/status`, {
                    method: 'PATCH',
                    headers: getHeaders(),
                    body: JSON.stringify({ TrangThai: newStatus })
                });

                if (res.ok) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Thành công!',
                        text: `Đã ${newStatus === 1 ? 'hiển thị' : 'ẩn'} đánh giá`,
                        timer: 1500,
                        showConfirmButton: false
                    });
                    loadReviews();
                }
            } catch (err) {
                Swal.fire('Lỗi!', 'Không thể cập nhật trạng thái', 'error');
            }
        }

        async function deleteReview(id) {
            const result = await Swal.fire({
                title: 'Xác nhận xóa?',
                text: 'Bạn có chắc muốn xóa đánh giá này?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Xóa',
                cancelButtonText: 'Hủy',
                confirmButtonColor: '#e74c3c'
            });

            if (result.isConfirmed) {
                try {
                    const res = await fetch(API_BASE_URL + `/api/admin/danhgia/${id}`, {
                        method: 'DELETE',
                        headers: getHeaders()
                    });

                    if (res.ok) {
                        Swal.fire('Thành công!', 'Đã xóa đánh giá', 'success');
                        loadReviews();
                        loadStats();
                    }
                } catch (err) {
                    Swal.fire('Lỗi!', 'Không thể xóa đánh giá', 'error');
                }
            }
        }

        // ========== KHỞI TẠO ==========
        checkAuth();
        loadStats();
    </script>
</body>
</html>