<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SportZoneVN</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="Trang_chu.css">
</head>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<style>
  .product-container { display: flex; flex-wrap: wrap; gap: 40px; margin-top: 50px; }
  .product-image { flex: 1; text-align: center; }
  .product-image img { max-width: 100%; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
  .product-info { flex: 1; }
  .product-name { font-size: 2rem; font-weight: bold; margin-bottom: 10px; }
  .product-price { color: #d32f2f; font-size: 1.6rem; font-weight: bold; margin-bottom: 20px; }
  .size-select { margin-bottom: 20px; }
  .btn-buy, .btn-cart { margin-right: 10px; }
  .btn-cart { background-color: #007bff; color: white; font-weight: bold; }
  .rating i { color: #ccc; cursor: pointer; font-size: 1.5rem; }
  .rating i.active { color: #f7b500; }
  .review-box { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-top: 60px; }

  .size-box {
    width: 45px; height: 45px; line-height: 45px; text-align: center;
    border: 2px solid #ccc; border-radius: 8px; cursor: pointer;
    font-weight: bold; user-select: none; transition: 0.2s;
  }
  .size-box:hover { border-color: #007bff; }
  .size-box.selected { background-color: #007bff; color: white; border-color: #007bff; }

  .back-home-btn {
    display: inline-flex; align-items: center; gap: 8px;
    padding: 10px 20px; background-color: #fff;
    border: 2px solid #020a12; border-radius: 30px;
    color: #010c16; font-weight: 600; text-decoration: none;
    transition: all 0.3s ease; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    margin-top: 15px; margin-left: -80px;
  }
  .back-home-btn:hover { background-color: #92979d; color: #fff; transform: translateY(-2px); }
</style>

<body>
  <div class="welcome">Chào mừng đến với SportZoneVn - Giày bóng đá chính hãng Việt Nam</div>

  <header>
    <div class="header-logo"><img src="/images/Logo_.png" alt=""></div>
    <div class="header-search">
      <i class="fa-solid fa-magnifying-glass"></i>
      <input type="text" placeholder="Tìm kiếm sản phẩm ...">
    </div>

    <div class="header_menu">
      <i class="fa-solid fa-user" id="userIcon"></i>
      <span id="userName" style="margin-left: 8px; font-weight: bold;"></span>
      <ul class="header_main_menu" id="menuList">
        <li id="registerLi"><a href="./Dang_ky.html">Đăng ký</a></li>
        <li id="loginLi"><a href="./Dang_nhap.html">Đăng nhập</a></li>
        <li id="logoutLi"><a href="./Dang_nhap.html">Đăng xuất</a></li>
      </ul>
    </div>
  <div class="header_gio_hang">
  <a href="Gio_Hang.html">
    <i class="fa-solid fa-cart-shopping"></i>
  </a>
</div>
  </header>

  <nav>
    <ul class="main_menu">
      <li><a href="Trang_chu.html">Trang chủ</a></li>

      <li class="submenu">
        <a href="#">Giày bóng đá</a>
        <ul class="has_submenu">
          <li><a href="#">Tất cả sản phẩm</a></li>
          <li><a href="#">Giày sân cỏ nhân tạo</a></li>
          <li><a href="#">Giày sân cỏ tự nhiên</a></li>
          <li><a href="#">Giày sân Futsal</a></li>
        </ul>
      </li>

      <li class="submenu">
        <a href="#">Thương hiệu</a>
        <ul class="has_submenu">
          <li><a href="#">Nike</a></li>
          <li><a href="#">Adidas</a></li>
          <li><a href="#">Puma</a></li>
          <li><a href="#">Mizuno</a></li>
          <li><a href="#">Kamito</a></li>
          <li><a href="#">Zocker</a></li>
        </ul>
      </li>

      <li><a href="Phu_Kien.html">Phụ kiện</a></li>
      <li><a href="Tin_Tuc_Giay.html">Tin tức giày</a></li>
      <li><a href="Khuyen_Mai.html">Khuyến mãi</a></li>
      <li><a href="Ve_chung_toi.html">Về chúng tôi</a></li>
    </ul>
  </nav>

  <main>
    <div class="container">
      <a href="/" class="back-home-btn">
        <i class="fa-solid fa-arrow-left"></i> Quay lại trang chủ
      </a>
      <div id="product-detail" class="product-container"></div>
    </div>

    <!-- Phần đánh giá -->
    <div class="review-box" id="review-box">
      <h3 class="mb-4"><i class="fa-solid fa-star text-warning"></i> Đánh giá sản phẩm</h3>
      <h5 id="trungBinhSao" class="mb-4 text-secondary"></h5>
      <div id="danhSachDanhGia" class="mb-4"></div>
      <hr>
      <h5>Gửi đánh giá của bạn</h5>

      <div class="rating mb-3" id="rating-stars">
        <i class="fa-solid fa-star" data-value="1"></i>
        <i class="fa-solid fa-star" data-value="2"></i>
        <i class="fa-solid fa-star" data-value="3"></i>
        <i class="fa-solid fa-star" data-value="4"></i>
        <i class="fa-solid fa-star" data-value="5"></i>
      </div>

      <input type="text" id="tieuDe" class="form-control mb-2" placeholder="Tiêu đề đánh giá">
      <textarea id="noiDung" class="form-control mb-2" rows="3" placeholder="Nhập nội dung đánh giá..."></textarea>
      <button id="btnGuiDanhGia" class="btn btn-primary">
        <i class="fa-solid fa-paper-plane"></i> Gửi đánh giá
      </button>
    </div>
  </main>

  <footer>
    <div class="hotline">
      <h2>THÔNG TIN LIÊN HỆ</h2>
      <h1>SportZoneVN - Giày bóng đá</h1>
      <p><i class="fa-solid fa-location-dot"></i> Địa chỉ: Đông Yên - Đông Sơn - Thanh Hóa</p>
      <p><i class="fa-solid fa-phone"></i> Hotline:0329127111</p>
      <p><i class="fa-solid fa-envelope"></i> Email:Doaducthiendeptrai@gmail.com</p>
    </div>

    <div class="lien_ket">
      <a href="https://www.facebook.com/thien.uc.609096"><i class="fa-brands fa-facebook"></i></a>
      <a href="https://www.instagram.com/qanh1010/"><i class="fa-brands fa-instagram"></i></a>
      <a href="https://www.youtube.com/@quyenanh8600"><i class="fa-brands fa-youtube"></i></a>
    </div>
  </footer>

  <div class="gb">SportZoneVn - Giày bóng đá chính hãng Việt Nam</div>

 
  <script>
    const user = localStorage.getItem("user");
    const userNameSpan = document.getElementById("userName");
    const registerLi = document.getElementById("registerLi");
    const loginLi = document.getElementById("loginLi");
    const logoutLi = document.getElementById("logoutLi");

    if (user) {
      const userData = JSON.parse(user);
      userNameSpan.textContent = userData.TenDangNhap;
      registerLi.style.display = "none";
      loginLi.style.display = "none";
      logoutLi.style.display = "block";
    } else {
      userNameSpan.textContent = "";
      registerLi.style.display = "block";
      loginLi.style.display = "block";
      logoutLi.style.display = "none";
    }

    logoutLi.querySelector('a').addEventListener('click', e => {
      e.preventDefault();
      localStorage.removeItem('token');
      localStorage.removeItem('user');
      window.location.href = "Dang_nhap.html";
    });
  </script>

  <script>
    // ======================= HIỂN THỊ CHI TIẾT SẢN PHẨM =======================
const urlParams = new URLSearchParams(window.location.search);
const id = urlParams.get('id');

if (!id) {
  document.getElementById('product-detail').innerHTML = '<p>Không tìm thấy sản phẩm.</p>';
} else {
  fetch(`/api/sanpham/${id}`)
    .then(res => {
      if (!res.ok) throw new Error('Không tìm thấy sản phẩm');
      return res.json();
    })
    .then(sp => {
      console.log("Sản phẩm trả về → ", sp);
      if (!sp.ten) {
        document.getElementById('product-detail').innerHTML = '<p>Không tìm thấy sản phẩm.</p>';
        return;
      }

      // ✅ Hiển thị sản phẩm
      document.getElementById('product-detail').innerHTML = `
        <div class="product-image">
          <img src="${sp.hinhAnh || '/images/default.jpg'}" alt="${sp.ten}">
        </div>
        <div class="product-info">
          <div class="product-name">${sp.ten}</div>
          <div class="product-price">${Number(sp.gia).toLocaleString()}₫</div>
          <p>${sp.moTa || 'Không có mô tả chi tiết.'}</p>

          <div class="size-select mb-3">
            <label class="form-label">Chọn size:</label>
            <div id="size-options" class="d-flex flex-wrap gap-2">
              ${[37,38,39,40,41,42,43].map(size => 
                `<div class="size-box" data-size="${size}">${size}</div>`
              ).join('')}
            </div>
          </div>

          <div class="quantity-select mb-3">
            <label class="form-label">Số lượng:</label>
            <input id="soLuong" type="number" min="1" max="${sp.soLuong || 10}" value="1" 
                   class="form-control" style="width:120px;">
          </div>

          <button class="btn btn-success btn-buy">Mua ngay</button>
          <button class="btn btn-primary btn-cart">Thêm vào giỏ hàng</button>
        </div>
      `;

      // ======================= CHỌN SIZE =======================
      let selectedSize = null;
      document.querySelectorAll('.size-box').forEach(box => {
        box.addEventListener('click', () => {
          document.querySelectorAll('.size-box').forEach(b => b.classList.remove('selected'));
          box.classList.add('selected');
          selectedSize = box.dataset.size;
        });
      });

      // ======================= NÚT "MUA NGAY" =======================
      document.querySelector('.btn-buy').addEventListener('click', () => {
        if (!selectedSize) {
          alert('Vui lòng chọn size trước khi mua!');
          return;
        }
        alert(`Bạn đã chọn mua ${sp.ten} - Size ${selectedSize}`);
        // TODO: Chuyển đến trang thanh toán
      });

      // ======================= NÚT "THÊM VÀO GIỎ HÀNG" =======================
      document.querySelector('.btn-cart').addEventListener('click', async () => {
        // Kiểm tra đã chọn size chưa
        if (!selectedSize) {
          alert('Vui lòng chọn size trước khi thêm vào giỏ hàng!');
          return;
        }

        // Kiểm tra đăng nhập
        const user = JSON.parse(localStorage.getItem('user'));
        if (!user || !user.MaTK) {
          alert('Vui lòng đăng nhập để thêm vào giỏ hàng!');
          window.location.href = 'Dang_nhap.html';
          return;
        }

        const soLuong = parseInt(document.getElementById('soLuong').value) || 1;

        // ✅ Gửi request lên server
        try {
          const response = await fetch('/api/giohang', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              MaKhachHang: user.MaTK,  
              MaSanPham: sp._id,     
              SoLuong: soLuong,
              Size: selectedSize
            })
          });

          const data = await response.json();

          if (response.ok) {
            alert('✅ Đã thêm vào giỏ hàng!');
            updateCartCount(); // Cập nhật số lượng icon giỏ hàng
          } else {
            alert('❌ Lỗi: ' + (data.error || 'Không thể thêm vào giỏ hàng'));
          }
        } catch (error) {
          console.error('Lỗi kết nối:', error);
          alert('❌ Không thể kết nối server! Vui lòng kiểm tra server đã chạy chưa.');
        }
      });

      // Gọi hàm hiển thị đánh giá (nếu có)
      if (typeof loadDanhGia === 'function') loadDanhGia();
      if (typeof loadTrungBinhSao === 'function') loadTrungBinhSao();
    })
    .catch(err => {
      console.error('Lỗi:', err);
      document.getElementById('product-detail').innerHTML = 
        `<p class="text-danger">Lỗi: ${err.message}</p>`;
    });
}

// ======================= CẬP NHẬT SỐ LƯỢNG GIỎ HÀNG =======================
async function updateCartCount() {
  const user = JSON.parse(localStorage.getItem('user'));
  if (!user || !user.MaTK) return;

  try {
    const res = await fetch(`/api/giohang/${user.MaTK}`);
    if (!res.ok) throw new Error('Không thể lấy giỏ hàng');
    
    const cart = await res.json();
    const count = cart.length || 0;

    // Hiển thị badge số lượng
    const cartIcon = document.querySelector('.header_gio_hang i');
    if (cartIcon) {
      cartIcon.setAttribute('data-count', count);
      
      // Thêm CSS cho badge (chỉ thêm 1 lần)
      if (!document.getElementById('cart-badge-style')) {
        const style = document.createElement('style');
        style.id = 'cart-badge-style';
        style.textContent = `
          .header_gio_hang {
            position: relative;
          }
          .header_gio_hang i[data-count]:after {
            content: attr(data-count);
            position: absolute;
            top: -8px;
            right: -8px;
            background: #dc3545;
            color: white;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 11px;
            font-weight: bold;
            min-width: 18px;
            text-align: center;
          }
          .header_gio_hang i[data-count="0"]:after {
            display: none;
          }
        `;
        document.head.appendChild(style);
      }
    }
  } catch (err) {
    console.error('Lỗi cập nhật giỏ hàng:', err);
  }
}

// Gọi khi load trang
updateCartCount();
loadDanhGia();
loadTrungBinhSao();

// ------------------- PHẦN ĐÁNH GIÁ -------------------
let selectedRating = 0;
document.querySelectorAll('#rating-stars i').forEach(star => {
  star.addEventListener('click', () => {
    selectedRating = parseInt(star.dataset.value);
    document.querySelectorAll('#rating-stars i').forEach(s => s.classList.remove('active'));
    for (let i = 0; i < selectedRating; i++) {
      document.querySelectorAll('#rating-stars i')[i].classList.add('active');
    }
  });
});

document.getElementById('btnGuiDanhGia').addEventListener('click', () => {
  const tieuDe = document.getElementById('tieuDe').value.trim();
  const noiDung = document.getElementById('noiDung').value.trim();

  if (!selectedRating) return alert('Vui lòng chọn số sao!');
  if (!tieuDe || !noiDung) return alert('Vui lòng nhập tiêu đề và nội dung!');

  const danhGia = {
    MaDanhGia: Date.now().toString(),
    TieuDe: tieuDe,
    NoiDung: noiDung,
    TrangThai: 1,
    NgayTao: new Date(),
    MaSanPham: id,
    MaThuongHieu: "TH001",
    MaKhachHang: "KH001",
    SoSao: selectedRating
  };

  fetch('/api/danhgia', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(danhGia)
  })
    .then(res => res.json())
    .then(() => {
      alert('Đã gửi đánh giá thành công!');
      document.getElementById('tieuDe').value = '';
      document.getElementById('noiDung').value = '';
      selectedRating = 0;
      document.querySelectorAll('#rating-stars i').forEach(s => s.classList.remove('active'));
      loadDanhGia();
      loadTrungBinhSao();
    })
    .catch(err => alert('Lỗi khi gửi đánh giá: ' + err));
});

function loadDanhGia() {
  fetch(`/api/danhgia/${id}`)
    .then(res => res.json())
    .then(danhGiaList => {
      const container = document.getElementById('danhSachDanhGia');
      if (!danhGiaList.length) {
        container.innerHTML = '<p>Chưa có đánh giá nào.</p>';
      } else {
        container.innerHTML = danhGiaList.map(dg => `
          <div class="border p-3 mb-2 rounded">
            <div class="d-flex align-items-center mb-1">
              ${'<i class="fa-solid fa-star text-warning"></i>'.repeat(dg.SoSao)}
            </div>
            <strong>${dg.TieuDe}</strong>
            <p>${dg.NoiDung}</p>
            <small class="text-muted">Ngày: ${new Date(dg.NgayTao).toLocaleDateString()}</small>
          </div>
        `).join('');
      }
    })
    .catch(() => {
      document.getElementById('danhSachDanhGia').innerHTML = '<p>Lỗi khi tải đánh giá.</p>';
    });
}

function loadTrungBinhSao() {
  fetch(`/api/danhgia/trungbinh/${id}`)
    .then(res => res.json())
    .then(data => {
      const trungBinh = data.avg ? data.avg.toFixed(1) : '0.0';
      const soDanhGia = data.count || 0;
      const trungBinhElem = document.getElementById('trungBinhSao');
      trungBinhElem.innerHTML = `
        <span class="fw-bold text-warning">${'★'.repeat(Math.round(data.avg || 0))}</span>
        <span class="text-secondary">(${trungBinh}/5 từ ${soDanhGia} đánh giá)</span>
      `;
    })
    .catch(() => {
      document.getElementById('trungBinhSao').textContent = 'Chưa có đánh giá nào.';
    });
}


  </script>

</body>
</html>
    